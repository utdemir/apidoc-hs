<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TemplateHaskellQuotes #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Apidoc</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Gen</span><span class="hs-operator">.</span><span class="hs-identifier">Utils</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language</span><span class="hs-operator">.</span><span class="hs-identifier">Haskell</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Functor</span><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Casing</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">Split</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">splitOn</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Attoparsec</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">match</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Int</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Calendar</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Day</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="Apidoc.TH.Internal.Gen.Simple.Types.html"><span class="hs-identifier">Apidoc</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span class="hs-operator">.</span><span class="hs-identifier">Gen</span><span class="hs-operator">.</span><span class="hs-identifier">Simple</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-22"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span class="hs-identifier">renderType</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-25"></a><a name="renderType"><a href="Apidoc.TH.Internal.Gen.Utils.html#renderType"><span class="hs-identifier">renderType</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pascal</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">last</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">splitOn</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-identifier">renderField</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-28"></a><a name="renderField"><a href="Apidoc.TH.Internal.Gen.Utils.html#renderField"><span class="hs-identifier">renderField</span></a></a><span> </span><a name="local-6989586621679130759"><a href="#local-6989586621679130759"><span class="hs-identifier">modelName</span></a></a><span> </span><a name="local-6989586621679130760"><a href="#local-6989586621679130760"><span class="hs-identifier">fieldName</span></a></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;_&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">camel</span><span> </span><span class="hs-special">(</span><a href="Apidoc.TH.Internal.Gen.Utils.html#renderType"><span class="hs-identifier hs-var">renderType</span></a><span> </span><a href="#local-6989586621679130759"><span class="hs-identifier hs-var">modelName</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">pascal</span><span> </span><a href="#local-6989586621679130760"><span class="hs-identifier hs-var">fieldName</span></a><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-identifier">tyToTypeReq</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Apidoc.TH.Internal.Gen.Simple.Types.html#Ty"><span class="hs-identifier hs-type">Ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span>
</span><a name="line-32"></a><a name="tyToTypeReq"><a href="Apidoc.TH.Internal.Gen.Utils.html#tyToTypeReq"><span class="hs-identifier">tyToTypeReq</span></a></a><span> </span><a name="local-6989586621679130761"><a href="#local-6989586621679130761"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621679130762"><a href="#local-6989586621679130762"><span class="hs-identifier">req</span></a></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679130762"><span class="hs-identifier hs-var">req</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">AppT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-char">''Maybe)) $ tyToType ty

tyToType :: Ty -&gt; Type
tyToType (Ty ty)
  = case parseOnly (parser &lt;* endOfInput) (T.pack ty) of
      Left err    -&gt; error $ &quot;Erorr parsing type: &quot; ++ ty ++ &quot;. Error: &quot; ++ err
      Right type_ -&gt; type_
  where
    parser :: Parser Type
    parser
        = &quot;boolean&quot;           $&gt; ConT ''Bool
      &lt;|&gt; &quot;date-iso8601&quot;      $&gt; ConT ''Day
      &lt;|&gt; &quot;date-time-iso8601&quot; $&gt; ConT ''UTCTime
      &lt;|&gt; &quot;decimal&quot;           $&gt; ConT ''Rational
      &lt;|&gt; &quot;double&quot;            $&gt; ConT ''Double
      &lt;|&gt; &quot;integer&quot;           $&gt; ConT ''Int32
      &lt;|&gt; &quot;long&quot;              $&gt; ConT ''Int64
      &lt;|&gt; &quot;object&quot;            $&gt; ConT ''Object
      &lt;|&gt; &quot;string&quot;            $&gt; ConT ''T.Text
      &lt;|&gt; &quot;unit&quot;              $&gt; ConT ''()
      &lt;|&gt; &quot;uuid&quot;              $&gt; ConT ''T.Text
      &lt;|&gt; listParser
      &lt;|&gt; mapParser
      &lt;|&gt; customParser

    listParser :: Parser Type
    listParser = AppT (ConT ''[]) &lt;$&gt; (&quot;[&quot; *&gt; parser &lt;* &quot;]&quot;)

    mapParser :: Parser Type
    mapParser = AppT (AppT (ConT ''Map) (ConT ''String)) &lt;$&gt; (&quot;map[&quot; *&gt; parser &lt;* &quot;]&quot;)

    customParser :: Parser Type
    customParser = ConT . mkName . renderType . T.unpack &lt;$&gt; A.takeWhile (inClass &quot;a-zA-Z0-9_.&quot;)

--------------------------------------------------------------------------------

app :: Name -&gt; [ExpQ] -&gt; ExpQ
app = foldl' appE . return . VarE

appTy :: Name -&gt; [TypeQ] -&gt; TypeQ
appTy = foldl' appT . return . ConT

-- | idiom f [p1, p2, p3] == [| f &lt;$&gt; p1 &lt;*&gt; p2 &lt;*&gt; p3 |]
idiom :: Q Exp -&gt; [Q Exp] -&gt; Q Exp
idiom con []     = con
idiom con (p:ps) = go (infixE (Just con) (varE '(&lt;$&gt;)) (Just p)) ps
  where
    go = foldl $ \ a x -&gt; infixE (Just a) (varE '(&lt;*&gt;)) (Just x)
</span></pre></body></html>