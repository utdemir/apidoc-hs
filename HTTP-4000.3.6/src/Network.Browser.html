<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses, GeneralizedNewtypeDeriving, CPP, FlexibleContexts #-}</span><span>
</span><a name="line-2"></a><span class="hs-comment">{- |

Module      :  Network.Browser
Copyright   :  See LICENSE file
License     :  BSD
 
Maintainer  :  Ganesh Sittampalam &lt;ganesh@earth.li&gt;
Stability   :  experimental
Portability :  non-portable (not tested)

Session-level interactions over HTTP.
 
The &quot;Network.Browser&quot; goes beyond the basic &quot;Network.HTTP&quot; functionality in 
providing support for more involved, and real, request/response interactions over 
HTTP. Additional features supported are:

* HTTP Authentication handling

* Transparent handling of redirects

* Cookie stores + transmission.

* Transaction logging

* Proxy-mediated connections.

Example use:

&gt;    do
&gt;      (_, rsp)
&gt;         &lt;- Network.Browser.browse $ do
&gt;               setAllowRedirects True -- handle HTTP redirects
&gt;               request $ getRequest &quot;http://www.haskell.org/&quot;
&gt;      return (take 100 (rspBody rsp))
 
-}</span><span>
</span><a name="line-38"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Browser</span><span> </span><span>
</span><a name="line-39"></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span>
</span><a name="line-40"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span>      </span><span class="hs-comment">-- browser monad, effectively a state monad.</span><span>
</span><a name="line-41"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>       </span><span>
</span><a name="line-43"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#browse"><span class="hs-identifier hs-var">browse</span></a><span>             </span><span class="hs-comment">-- :: BrowserAction a -&gt; IO a</span><span>
</span><a name="line-44"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#request"><span class="hs-identifier hs-var">request</span></a><span>            </span><span class="hs-comment">-- :: Request -&gt; BrowserAction Response</span><span>
</span><a name="line-45"></a><span>    </span><span>
</span><a name="line-46"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getBrowserState"><span class="hs-identifier hs-var">getBrowserState</span></a><span>    </span><span class="hs-comment">-- :: BrowserAction t (BrowserState t)</span><span>
</span><a name="line-47"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#withBrowserState"><span class="hs-identifier hs-var">withBrowserState</span></a><span>   </span><span class="hs-comment">-- :: BrowserState t -&gt; BrowserAction t a -&gt; BrowserAction t a</span><span>
</span><a name="line-48"></a><span>       </span><span>
</span><a name="line-49"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setAllowRedirects"><span class="hs-identifier hs-var">setAllowRedirects</span></a><span>  </span><span class="hs-comment">-- :: Bool -&gt; BrowserAction t ()</span><span>
</span><a name="line-50"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getAllowRedirects"><span class="hs-identifier hs-var">getAllowRedirects</span></a><span>  </span><span class="hs-comment">-- :: BrowserAction t Bool</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setMaxRedirects"><span class="hs-identifier hs-var">setMaxRedirects</span></a><span>    </span><span class="hs-comment">-- :: Int -&gt; BrowserAction t ()</span><span>
</span><a name="line-53"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getMaxRedirects"><span class="hs-identifier hs-var">getMaxRedirects</span></a><span>    </span><span class="hs-comment">-- :: BrowserAction t (Maybe Int)</span><span>
</span><a name="line-54"></a><span>       </span><span>
</span><a name="line-55"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getAuthorities"><span class="hs-identifier hs-var">getAuthorities</span></a><span>
</span><a name="line-57"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setAuthorities"><span class="hs-identifier hs-var">setAuthorities</span></a><span>
</span><a name="line-58"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#addAuthority"><span class="hs-identifier hs-var">addAuthority</span></a><span>
</span><a name="line-59"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Auth.html#Challenge"><span class="hs-identifier hs-type">Challenge</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Auth.html#Qop"><span class="hs-identifier hs-type">Qop</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-61"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Auth.html#Algorithm"><span class="hs-identifier hs-type">Algorithm</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span>       </span><span>
</span><a name="line-63"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getAuthorityGen"><span class="hs-identifier hs-var">getAuthorityGen</span></a><span>
</span><a name="line-64"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setAuthorityGen"><span class="hs-identifier hs-var">setAuthorityGen</span></a><span>
</span><a name="line-65"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setAllowBasicAuth"><span class="hs-identifier hs-var">setAllowBasicAuth</span></a><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getAllowBasicAuth"><span class="hs-identifier hs-var">getAllowBasicAuth</span></a><span>
</span><a name="line-67"></a><span>       </span><span>
</span><a name="line-68"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setMaxErrorRetries"><span class="hs-identifier hs-var">setMaxErrorRetries</span></a><span>  </span><span class="hs-comment">-- :: Maybe Int -&gt; BrowserAction t ()</span><span>
</span><a name="line-69"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getMaxErrorRetries"><span class="hs-identifier hs-var">getMaxErrorRetries</span></a><span>  </span><span class="hs-comment">-- :: BrowserAction t (Maybe Int)</span><span>
</span><a name="line-70"></a><span>
</span><a name="line-71"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setMaxPoolSize"><span class="hs-identifier hs-var">setMaxPoolSize</span></a><span>     </span><span class="hs-comment">-- :: Int -&gt; BrowserAction t ()</span><span>
</span><a name="line-72"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getMaxPoolSize"><span class="hs-identifier hs-var">getMaxPoolSize</span></a><span>     </span><span class="hs-comment">-- :: BrowserAction t (Maybe Int)</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setMaxAuthAttempts"><span class="hs-identifier hs-var">setMaxAuthAttempts</span></a><span>  </span><span class="hs-comment">-- :: Maybe Int -&gt; BrowserAction t ()</span><span>
</span><a name="line-75"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getMaxAuthAttempts"><span class="hs-identifier hs-var">getMaxAuthAttempts</span></a><span>  </span><span class="hs-comment">-- :: BrowserAction t (Maybe Int)</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setCookieFilter"><span class="hs-identifier hs-var">setCookieFilter</span></a><span>     </span><span class="hs-comment">-- :: (URI -&gt; Cookie -&gt; IO Bool) -&gt; BrowserAction t ()</span><span>
</span><a name="line-78"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getCookieFilter"><span class="hs-identifier hs-var">getCookieFilter</span></a><span>     </span><span class="hs-comment">-- :: BrowserAction t (URI -&gt; Cookie -&gt; IO Bool)</span><span>
</span><a name="line-79"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#defaultCookieFilter"><span class="hs-identifier hs-var">defaultCookieFilter</span></a><span> </span><span class="hs-comment">-- :: URI -&gt; Cookie -&gt; IO Bool</span><span>
</span><a name="line-80"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#userCookieFilter"><span class="hs-identifier hs-var">userCookieFilter</span></a><span>    </span><span class="hs-comment">-- :: URI -&gt; Cookie -&gt; IO Bool</span><span>
</span><a name="line-81"></a><span>       </span><span>
</span><a name="line-82"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-83"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getCookies"><span class="hs-identifier hs-var">getCookies</span></a><span>        </span><span class="hs-comment">-- :: BrowserAction t [Cookie]</span><span>
</span><a name="line-84"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setCookies"><span class="hs-identifier hs-var">setCookies</span></a><span>        </span><span class="hs-comment">-- :: [Cookie] -&gt; BrowserAction t ()</span><span>
</span><a name="line-85"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#addCookie"><span class="hs-identifier hs-var">addCookie</span></a><span>         </span><span class="hs-comment">-- :: Cookie   -&gt; BrowserAction t ()</span><span>
</span><a name="line-86"></a><span>       </span><span>
</span><a name="line-87"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setErrHandler"><span class="hs-identifier hs-var">setErrHandler</span></a><span>     </span><span class="hs-comment">-- :: (String -&gt; IO ()) -&gt; BrowserAction t ()</span><span>
</span><a name="line-88"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setOutHandler"><span class="hs-identifier hs-var">setOutHandler</span></a><span>     </span><span class="hs-comment">-- :: (String -&gt; IO ()) -&gt; BrowserAction t ()</span><span>
</span><a name="line-89"></a><span>    </span><span>
</span><a name="line-90"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setEventHandler"><span class="hs-identifier hs-var">setEventHandler</span></a><span>   </span><span class="hs-comment">-- :: (BrowserEvent -&gt; BrowserAction t ()) -&gt; BrowserAction t ()</span><span>
</span><a name="line-91"></a><span>       </span><span>
</span><a name="line-92"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier hs-type">BrowserEvent</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#BrowserEventType"><span class="hs-identifier hs-type">BrowserEventType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a><span>
</span><a name="line-95"></a><span>       </span><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setProxy"><span class="hs-identifier hs-var">setProxy</span></a><span>         </span><span class="hs-comment">-- :: Proxy -&gt; BrowserAction t ()</span><span>
</span><a name="line-97"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getProxy"><span class="hs-identifier hs-var">getProxy</span></a><span>         </span><span class="hs-comment">-- :: BrowserAction t Proxy</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setCheckForProxy"><span class="hs-identifier hs-var">setCheckForProxy</span></a><span> </span><span class="hs-comment">-- :: Bool -&gt; BrowserAction t ()</span><span>
</span><a name="line-100"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getCheckForProxy"><span class="hs-identifier hs-var">getCheckForProxy</span></a><span> </span><span class="hs-comment">-- :: BrowserAction t Bool</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setDebugLog"><span class="hs-identifier hs-var">setDebugLog</span></a><span>      </span><span class="hs-comment">-- :: Maybe String -&gt; BrowserAction t ()</span><span>
</span><a name="line-103"></a><span>       </span><span>
</span><a name="line-104"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#getUserAgent"><span class="hs-identifier hs-var">getUserAgent</span></a><span>     </span><span class="hs-comment">-- :: BrowserAction t String</span><span>
</span><a name="line-105"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#setUserAgent"><span class="hs-identifier hs-var">setUserAgent</span></a><span>     </span><span class="hs-comment">-- :: String -&gt; BrowserAction t ()</span><span>
</span><a name="line-106"></a><span>       </span><span>
</span><a name="line-107"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span>              </span><span class="hs-comment">-- :: String -&gt; BrowserAction t ()</span><span>
</span><a name="line-108"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span>              </span><span class="hs-comment">-- :: String -&gt; BrowserAction t ()</span><span>
</span><a name="line-109"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#ioAction"><span class="hs-identifier hs-var">ioAction</span></a><span>         </span><span class="hs-comment">-- :: IO a -&gt; BrowserAction a</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Base.html#defaultGETRequest"><span class="hs-identifier hs-var">defaultGETRequest</span></a><span>
</span><a name="line-112"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.HTTP.Base.html#defaultGETRequest_"><span class="hs-identifier hs-var">defaultGETRequest_</span></a><span>
</span><a name="line-113"></a><span>       </span><span>
</span><a name="line-114"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#formToRequest"><span class="hs-identifier hs-var">formToRequest</span></a><span>
</span><a name="line-115"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#uriDefaultTo"><span class="hs-identifier hs-var">uriDefaultTo</span></a><span>
</span><a name="line-116"></a><span>       </span><span>
</span><a name="line-117"></a><span>         </span><span class="hs-comment">-- old and half-baked; don't use:</span><span>
</span><a name="line-118"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#Form"><span class="hs-identifier hs-type">Form</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Network.Browser.html#FormVar"><span class="hs-identifier hs-type">FormVar</span></a><span>
</span><a name="line-120"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">URI</span><span>
</span><a name="line-123"></a><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">URI</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">URIAuth</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-125"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parseURI</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">parseURIReference</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">relativeTo</span><span>
</span><a name="line-126"></a><span>   </span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span class="hs-keyword">import</span><span> </span><a href="Network.StreamDebugger.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">StreamDebugger</span></a><span> </span><span class="hs-special">(</span><a href="Network.StreamDebugger.html#debugByteStream"><span class="hs-identifier hs-var">debugByteStream</span></a><span class="hs-special">)</span><span>
</span><a name="line-128"></a><span class="hs-keyword">import</span><span> </span><a href="Network.HTTP.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="Network.HTTP.html#sendHTTP_notify"><span class="hs-identifier hs-var">sendHTTP_notify</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span class="hs-keyword">import</span><span> </span><a href="Network.HTTP.HandleStream.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">HandleStream</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Network.HTTP.HandleStream.html#sendHTTP_notify"><span class="hs-identifier hs-var">sendHTTP_notify</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-130"></a><span class="hs-keyword">import</span><span> </span><a href="Network.HTTP.Auth.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">Auth</span></a><span>
</span><a name="line-131"></a><span class="hs-keyword">import</span><span> </span><a href="Network.HTTP.Cookie.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">Cookie</span></a><span>
</span><a name="line-132"></a><span class="hs-keyword">import</span><span> </span><a href="Network.HTTP.Proxy.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">Proxy</span></a><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-keyword">import</span><span> </span><a href="Network.Stream.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">Stream</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Network.Stream.html#ConnError"><span class="hs-identifier hs-type">ConnError</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Network.Stream.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span class="hs-keyword">import</span><span> </span><a href="Network.BufferType.html"><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">BufferType</span></a><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Char</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toLower</span><span class="hs-special">)</span><span>
</span><a name="line-138"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span class="hs-cpp">#ifdef MTL1</span><span>
</span><a name="line-142"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filterM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">forM_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">when</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ap</span><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-144"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">forM_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">when</span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-146"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">State</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">StateT</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">modify</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">gets</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">withStateT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">evalStateT</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadState</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>
</span><a name="line-148"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span>
</span><a name="line-149"></a><span>   </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">hSetBuffering</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hPutStr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stdout</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">stdin</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">hGetChar</span><span>
</span><a name="line-150"></a><span>   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">BufferMode</span><span class="hs-special">(</span><span class="hs-identifier hs-var">NoBuffering</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">LineBuffering</span><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>   </span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-156"></a><span class="hs-comment">----------------------- Cookie Stuff -----------------------------</span><span>
</span><a name="line-157"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-comment">-- | @defaultCookieFilter@ is the initial cookie acceptance filter.</span><span>
</span><a name="line-160"></a><span class="hs-comment">-- It welcomes them all into the store @:-)@</span><span>
</span><a name="line-161"></a><span class="hs-identifier">defaultCookieFilter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-162"></a><a name="defaultCookieFilter"><a href="Network.Browser.html#defaultCookieFilter"><span class="hs-identifier">defaultCookieFilter</span></a></a><span> </span><a name="local-6989586621679084194"><a href="#local-6989586621679084194"><span class="hs-identifier">_url</span></a></a><span> </span><a name="local-6989586621679084195"><a href="#local-6989586621679084195"><span class="hs-identifier">_cky</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-comment">-- | @userCookieFilter@ is a handy acceptance filter, asking the</span><span>
</span><a name="line-165"></a><span class="hs-comment">-- user if he/she is willing to accept an incoming cookie before</span><span>
</span><a name="line-166"></a><span class="hs-comment">-- adding it to the store.</span><span>
</span><a name="line-167"></a><span class="hs-identifier">userCookieFilter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-168"></a><a name="userCookieFilter"><a href="Network.Browser.html#userCookieFilter"><span class="hs-identifier">userCookieFilter</span></a></a><span> </span><a name="local-6989586621679084196"><a href="#local-6989586621679084196"><span class="hs-identifier">url</span></a></a><span> </span><a name="local-6989586621679084197"><a href="#local-6989586621679084197"><span class="hs-identifier">cky</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-169"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Set-Cookie received when requesting: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084196"><span class="hs-identifier hs-var">url</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span>       </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">ckComment</span><span> </span><a href="#local-6989586621679084197"><span class="hs-identifier hs-var">cky</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-171"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084198"><a href="#local-6989586621679084198"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Cookie Comment:\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679084198"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084199"><a href="#local-6989586621679084199"><span class="hs-identifier">pth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-string">&quot;&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-char">'/'</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ckPath</span><span> </span><a href="#local-6989586621679084197"><span class="hs-identifier hs-var">cky</span></a><span class="hs-special">)</span><span>
</span><a name="line-174"></a><span>       </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Domain/Path: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">ckDomain</span><span> </span><a href="#local-6989586621679084197"><span class="hs-identifier hs-var">cky</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679084199"><span class="hs-identifier hs-var">pth</span></a><span class="hs-special">)</span><span>
</span><a name="line-175"></a><span>       </span><span class="hs-identifier hs-var">putStrLn</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ckName</span><span> </span><a href="#local-6989586621679084197"><span class="hs-identifier hs-var">cky</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-char">'='</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">ckValue</span><span> </span><a href="#local-6989586621679084197"><span class="hs-identifier hs-var">cky</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">stdout</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NoBuffering</span><span>
</span><a name="line-177"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">stdin</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">NoBuffering</span><span>
</span><a name="line-178"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hPutStr</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">stdout</span><span> </span><span class="hs-string">&quot;Accept [y/n]? &quot;</span><span>
</span><a name="line-179"></a><span>       </span><a name="local-6989586621679084200"><a href="#local-6989586621679084200"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hGetChar</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">stdin</span><span>
</span><a name="line-180"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">stdin</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">LineBuffering</span><span>
</span><a name="line-181"></a><span>       </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">hSetBuffering</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">stdout</span><span> </span><span class="hs-identifier hs-var">System</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">IO</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">LineBuffering</span><span>
</span><a name="line-182"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toLower</span><span> </span><a href="#local-6989586621679084200"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'y'</span><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span>
</span><a name="line-184"></a><span class="hs-comment">-- | @addCookie c@ adds a cookie to the browser state, removing duplicates.</span><span>
</span><a name="line-185"></a><span class="hs-identifier">addCookie</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084193"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-186"></a><a name="addCookie"><a href="Network.Browser.html#addCookie"><span class="hs-identifier">addCookie</span></a></a><span> </span><a name="local-6989586621679084201"><a href="#local-6989586621679084201"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084202"><a href="#local-6989586621679084202"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084202"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsCookies</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084201"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><a href="#local-6989586621679084201"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bsCookies</span><span> </span><a href="#local-6989586621679084202"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span class="hs-comment">-- | @setCookies cookies@ replaces the set of cookies known to</span><span>
</span><a name="line-189"></a><span class="hs-comment">-- the browser to @cookies@. Useful when wanting to restore cookies</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- used across 'browse' invocations.</span><span>
</span><a name="line-191"></a><span class="hs-identifier">setCookies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084192"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><a name="setCookies"><a href="Network.Browser.html#setCookies"><span class="hs-identifier">setCookies</span></a></a><span> </span><a name="local-6989586621679084203"><a href="#local-6989586621679084203"><span class="hs-identifier">cs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084204"><a href="#local-6989586621679084204"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084204"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsCookies</span><span class="hs-glyph">=</span><a href="#local-6989586621679084203"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>
</span><a name="line-194"></a><span class="hs-comment">-- | @getCookies@ returns the current set of cookies known to</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- the browser.</span><span>
</span><a name="line-196"></a><span class="hs-identifier">getCookies</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084191"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span class="hs-special">]</span><span>
</span><a name="line-197"></a><a name="getCookies"><a href="Network.Browser.html#getCookies"><span class="hs-identifier">getCookies</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsCookies</span><span>
</span><a name="line-198"></a><span>
</span><a name="line-199"></a><span class="hs-comment">-- ...get domain specific cookies...</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- ... this needs changing for consistency with rfc2109...</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- ... currently too broad.</span><span>
</span><a name="line-202"></a><span class="hs-identifier">getCookiesFor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084190"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span class="hs-special">]</span><span>
</span><a name="line-203"></a><a name="getCookiesFor"><a href="Network.Browser.html#getCookiesFor"><span class="hs-identifier">getCookiesFor</span></a></a><span> </span><a name="local-6989586621679084205"><a href="#local-6989586621679084205"><span class="hs-identifier">dom</span></a></a><span> </span><a name="local-6989586621679084206"><a href="#local-6989586621679084206"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-204"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679084208"><a href="#local-6989586621679084208"><span class="hs-identifier">cks</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getCookies"><span class="hs-identifier hs-var">getCookies</span></a><span>
</span><a name="line-205"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679084207"><span class="hs-identifier hs-var">cookiematch</span></a><span> </span><a href="#local-6989586621679084208"><span class="hs-identifier hs-var">cks</span></a><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-207"></a><span>        </span><span class="hs-identifier">cookiematch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-208"></a><span>        </span><a name="local-6989586621679084207"><a href="#local-6989586621679084207"><span class="hs-identifier">cookiematch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Cookie.html#cookieMatch"><span class="hs-identifier hs-var">cookieMatch</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084205"><span class="hs-identifier hs-var">dom</span></a><span class="hs-special">,</span><a href="#local-6989586621679084206"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>      </span><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-comment">-- | @setCookieFilter fn@ sets the cookie acceptance filter to @fn@.</span><span>
</span><a name="line-212"></a><span class="hs-identifier">setCookieFilter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084189"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><a name="setCookieFilter"><a href="Network.Browser.html#setCookieFilter"><span class="hs-identifier">setCookieFilter</span></a></a><span> </span><a name="local-6989586621679084209"><a href="#local-6989586621679084209"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084210"><a href="#local-6989586621679084210"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084210"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsCookieFilter</span><span class="hs-glyph">=</span><a href="#local-6989586621679084209"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">-- | @getCookieFilter@ returns the current cookie acceptance filter.</span><span>
</span><a name="line-216"></a><span class="hs-identifier">getCookieFilter</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084188"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><a name="getCookieFilter"><a href="Network.Browser.html#getCookieFilter"><span class="hs-identifier">getCookieFilter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsCookieFilter</span><span>
</span><a name="line-218"></a><span>
</span><a name="line-219"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-220"></a><span class="hs-comment">----------------------- Authorisation Stuff ----------------------</span><span>
</span><a name="line-221"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-222"></a><span>
</span><a name="line-223"></a><span class="hs-comment">{-

The browser handles 401 responses in the following manner:
  1) extract all WWW-Authenticate headers from a 401 response
  2) rewrite each as a Challenge object, using &quot;headerToChallenge&quot;
  3) pick a challenge to respond to, usually the strongest
     challenge understood by the client, using &quot;pickChallenge&quot;
  4) generate a username/password combination using the browsers
     &quot;bsAuthorityGen&quot; function (the default behaviour is to ask
     the user)
  5) build an Authority object based upon the challenge and user
     data, store this new Authority in the browser state
  6) convert the Authority to a request header and add this
     to a request using &quot;withAuthority&quot;
  7) send the amended request

Note that by default requests are annotated with authority headers
before the first sending, based upon previously generated Authority
objects (which contain domain information).  Once a specific authority
is added to a rejected request this predictive annotation is suppressed.

407 responses are handled in a similar manner, except
   a) Authorities are not collected, only a single proxy authority
      is kept by the browser
   b) If the proxy used by the browser (type Proxy) is NoProxy, then
      a 407 response will generate output on the &quot;err&quot; stream and
      the response will be returned.


Notes:
 - digest authentication so far ignores qop, so fails to authenticate 
   properly with qop=auth-int challenges
 - calculates a1 more than necessary
 - doesn't reverse authenticate
 - doesn't properly receive AuthenticationInfo headers, so fails
   to use next-nonce etc

-}</span><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-comment">-- | Return authorities for a given domain and path.</span><span>
</span><a name="line-263"></a><span class="hs-comment">-- Assumes &quot;dom&quot; is lower case</span><span>
</span><a name="line-264"></a><span class="hs-identifier">getAuthFor</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084187"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">]</span><span>
</span><a name="line-265"></a><a name="getAuthFor"><a href="Network.Browser.html#getAuthFor"><span class="hs-identifier">getAuthFor</span></a></a><span> </span><a name="local-6989586621679084211"><a href="#local-6989586621679084211"><span class="hs-identifier">dom</span></a></a><span> </span><a name="local-6989586621679084212"><a href="#local-6989586621679084212"><span class="hs-identifier">pth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#getAuthorities"><span class="hs-identifier hs-var">getAuthorities</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621679084213"><span class="hs-identifier hs-var">match</span></a><span class="hs-special">)</span><span>
</span><a name="line-266"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-identifier">match</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-268"></a><span>    </span><a name="local-6989586621679084213"><a href="#local-6989586621679084213"><span class="hs-identifier">match</span></a></a><span> </span><a name="local-6989586621679084215"><a href="#local-6989586621679084215"><span class="hs-identifier">au</span></a></a><span class="hs-glyph">@</span><a href="Network.HTTP.Auth.html#AuthBasic"><span class="hs-identifier hs-var">AuthBasic</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084214"><span class="hs-identifier hs-var">matchURI</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">auSite</span><span> </span><a href="#local-6989586621679084215"><span class="hs-identifier hs-var">au</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>    </span><span class="hs-identifier">match</span><span> </span><a name="local-6989586621679084216"><a href="#local-6989586621679084216"><span class="hs-identifier">au</span></a></a><span class="hs-glyph">@</span><a href="Network.HTTP.Auth.html#AuthDigest"><span class="hs-identifier hs-var">AuthDigest</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">or</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679084214"><span class="hs-identifier hs-var">matchURI</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">auDomain</span><span> </span><a href="#local-6989586621679084216"><span class="hs-identifier hs-var">au</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span>    </span><span class="hs-identifier">matchURI</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-272"></a><span>    </span><a name="local-6989586621679084214"><a href="#local-6989586621679084214"><span class="hs-identifier">matchURI</span></a></a><span> </span><a name="local-6989586621679084217"><a href="#local-6989586621679084217"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#uriToAuthorityString"><span class="hs-identifier hs-var">uriToAuthorityString</span></a><span> </span><a href="#local-6989586621679084217"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679084211"><span class="hs-identifier hs-var">dom</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriPath</span><span> </span><a href="#local-6989586621679084217"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679084212"><span class="hs-identifier hs-var">pth</span></a><span class="hs-special">)</span><span>
</span><a name="line-273"></a><span>    </span><span>
</span><a name="line-274"></a><span>
</span><a name="line-275"></a><span class="hs-comment">-- | @getAuthorities@ return the current set of @Authority@s known</span><span>
</span><a name="line-276"></a><span class="hs-comment">-- to the browser.</span><span>
</span><a name="line-277"></a><span class="hs-identifier">getAuthorities</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084186"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">]</span><span>
</span><a name="line-278"></a><a name="getAuthorities"><a href="Network.Browser.html#getAuthorities"><span class="hs-identifier">getAuthorities</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsAuthorities</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-comment">-- @setAuthorities as@ replaces the Browser's known set</span><span>
</span><a name="line-281"></a><span class="hs-comment">-- of 'Authority's to @as@.</span><span>
</span><a name="line-282"></a><span class="hs-identifier">setAuthorities</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084185"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-283"></a><a name="setAuthorities"><a href="Network.Browser.html#setAuthorities"><span class="hs-identifier">setAuthorities</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084219"><a href="#local-6989586621679084219"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084219"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsAuthorities</span><span class="hs-glyph">=</span><span class="hs-keyword">as</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span class="hs-comment">-- @addAuthority a@ adds 'Authority' @a@ to the Browser's</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- set of known authorities.</span><span>
</span><a name="line-287"></a><span class="hs-identifier">addAuthority</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084184"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-288"></a><a name="addAuthority"><a href="Network.Browser.html#addAuthority"><span class="hs-identifier">addAuthority</span></a></a><span> </span><a name="local-6989586621679084220"><a href="#local-6989586621679084220"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084221"><a href="#local-6989586621679084221"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084221"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsAuthorities</span><span class="hs-glyph">=</span><a href="#local-6989586621679084220"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-identifier">bsAuthorities</span><span> </span><a href="#local-6989586621679084221"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>
</span><a name="line-290"></a><span class="hs-comment">-- | @getAuthorityGen@ returns the current authority generator</span><span>
</span><a name="line-291"></a><span class="hs-identifier">getAuthorityGen</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084183"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-292"></a><a name="getAuthorityGen"><a href="Network.Browser.html#getAuthorityGen"><span class="hs-identifier">getAuthorityGen</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsAuthorityGen</span><span>
</span><a name="line-293"></a><span>
</span><a name="line-294"></a><span class="hs-comment">-- | @setAuthorityGen genAct@ sets the auth generator to @genAct@.</span><span>
</span><a name="line-295"></a><span class="hs-identifier">setAuthorityGen</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084182"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><a name="setAuthorityGen"><a href="Network.Browser.html#setAuthorityGen"><span class="hs-identifier">setAuthorityGen</span></a></a><span> </span><a name="local-6989586621679084222"><a href="#local-6989586621679084222"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084223"><a href="#local-6989586621679084223"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084223"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsAuthorityGen</span><span class="hs-glyph">=</span><a href="#local-6989586621679084222"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-297"></a><span>
</span><a name="line-298"></a><span class="hs-comment">-- | @setAllowBasicAuth onOff@ enables\/disables HTTP Basic Authentication.</span><span>
</span><a name="line-299"></a><span class="hs-identifier">setAllowBasicAuth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084181"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><a name="setAllowBasicAuth"><a href="Network.Browser.html#setAllowBasicAuth"><span class="hs-identifier">setAllowBasicAuth</span></a></a><span> </span><a name="local-6989586621679084224"><a href="#local-6989586621679084224"><span class="hs-identifier">ba</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084225"><a href="#local-6989586621679084225"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084225"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsAllowBasicAuth</span><span class="hs-glyph">=</span><a href="#local-6989586621679084224"><span class="hs-identifier hs-var">ba</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>
</span><a name="line-302"></a><span class="hs-identifier">getAllowBasicAuth</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084180"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-303"></a><a name="getAllowBasicAuth"><a href="Network.Browser.html#getAllowBasicAuth"><span class="hs-identifier">getAllowBasicAuth</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsAllowBasicAuth</span><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-comment">-- | @setMaxAuthAttempts mbMax@ sets the maximum number of authentication attempts</span><span>
</span><a name="line-306"></a><span class="hs-comment">-- to do. If @Nothing@, rever to default max.</span><span>
</span><a name="line-307"></a><span class="hs-identifier">setMaxAuthAttempts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084179"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><a name="setMaxAuthAttempts"><a href="Network.Browser.html#setMaxAuthAttempts"><span class="hs-identifier">setMaxAuthAttempts</span></a></a><span> </span><a name="local-6989586621679084226"><a href="#local-6989586621679084226"><span class="hs-identifier">mb</span></a></a><span> </span><span>
</span><a name="line-309"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679084226"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-310"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679084227"><a href="#local-6989586621679084227"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084227"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsMaxAuthAttempts</span><span class="hs-glyph">=</span><a href="#local-6989586621679084226"><span class="hs-identifier hs-var">mb</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- | @getMaxAuthAttempts@ returns the current max auth attempts. If @Nothing@,</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- the browser's default is used.</span><span>
</span><a name="line-314"></a><span class="hs-identifier">getMaxAuthAttempts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084178"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-315"></a><a name="getMaxAuthAttempts"><a href="Network.Browser.html#getMaxAuthAttempts"><span class="hs-identifier">getMaxAuthAttempts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsMaxAuthAttempts</span><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-comment">-- | @setMaxErrorRetries mbMax@ sets the maximum number of attempts at</span><span>
</span><a name="line-318"></a><span class="hs-comment">-- transmitting a request. If @Nothing@, rever to default max.</span><span>
</span><a name="line-319"></a><span class="hs-identifier">setMaxErrorRetries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084177"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-320"></a><a name="setMaxErrorRetries"><a href="Network.Browser.html#setMaxErrorRetries"><span class="hs-identifier">setMaxErrorRetries</span></a></a><span> </span><a name="local-6989586621679084228"><a href="#local-6989586621679084228"><span class="hs-identifier">mb</span></a></a><span>
</span><a name="line-321"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679084228"><span class="hs-identifier hs-var">mb</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679084229"><a href="#local-6989586621679084229"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084229"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsMaxErrorRetries</span><span class="hs-glyph">=</span><a href="#local-6989586621679084228"><span class="hs-identifier hs-var">mb</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><span>
</span><a name="line-324"></a><span class="hs-comment">-- | @getMaxErrorRetries@ returns the current max number of error retries.</span><span>
</span><a name="line-325"></a><span class="hs-identifier">getMaxErrorRetries</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084176"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-326"></a><a name="getMaxErrorRetries"><a href="Network.Browser.html#getMaxErrorRetries"><span class="hs-identifier">getMaxErrorRetries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsMaxErrorRetries</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">-- TO BE CHANGED!!!</span><span>
</span><a name="line-329"></a><span class="hs-identifier">pickChallenge</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Auth.html#Challenge"><span class="hs-identifier hs-type">Challenge</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Network.HTTP.Auth.html#Challenge"><span class="hs-identifier hs-type">Challenge</span></a><span>
</span><a name="line-330"></a><a name="pickChallenge"><a href="Network.Browser.html#pickChallenge"><span class="hs-identifier">pickChallenge</span></a></a><span> </span><a name="local-6989586621679084230"><a href="#local-6989586621679084230"><span class="hs-identifier">allowBasic</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-331"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679084230"><span class="hs-identifier hs-var">allowBasic</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#ChalBasic"><span class="hs-identifier hs-var">ChalBasic</span></a><span> </span><span class="hs-string">&quot;/&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- manufacture a challenge if one missing; more robust.</span><span>
</span><a name="line-332"></a><span class="hs-identifier">pickChallenge</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679084231"><a href="#local-6989586621679084231"><span class="hs-identifier">ls</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><a href="#local-6989586621679084231"><span class="hs-identifier hs-var">ls</span></a><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span class="hs-comment">-- | Retrieve a likely looking authority for a Request.</span><span>
</span><a name="line-335"></a><span class="hs-identifier">anticipateChallenge</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Base.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><a href="#local-6989586621679084174"><span class="hs-identifier hs-type">ty</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084175"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><a name="anticipateChallenge"><a href="Network.Browser.html#anticipateChallenge"><span class="hs-identifier">anticipateChallenge</span></a></a><span> </span><a name="local-6989586621679084232"><a href="#local-6989586621679084232"><span class="hs-identifier">rq</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084233"><a href="#local-6989586621679084233"><span class="hs-identifier">uri</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084232"><span class="hs-identifier hs-var">rq</span></a><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-338"></a><span>    </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679084234"><a href="#local-6989586621679084234"><span class="hs-identifier">authlist</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getAuthFor"><span class="hs-identifier hs-var">getAuthFor</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#uriAuthToString"><span class="hs-identifier hs-var">uriAuthToString</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.HTTP.Base.html#reqURIAuth"><span class="hs-identifier hs-var">reqURIAuth</span></a><span> </span><a href="#local-6989586621679084232"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriPath</span><span> </span><a href="#local-6989586621679084233"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span>
</span><a name="line-339"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listToMaybe</span><span> </span><a href="#local-6989586621679084234"><span class="hs-identifier hs-var">authlist</span></a><span class="hs-special">)</span><span>
</span><a name="line-340"></a><span>       </span><span class="hs-special">}</span><span>
</span><a name="line-341"></a><span>
</span><a name="line-342"></a><span class="hs-comment">-- | Asking the user to respond to a challenge</span><span>
</span><a name="line-343"></a><span class="hs-identifier">challengeToAuthority</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Auth.html#Challenge"><span class="hs-identifier hs-type">Challenge</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084173"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">)</span><span>
</span><a name="line-344"></a><a name="challengeToAuthority"><a href="Network.Browser.html#challengeToAuthority"><span class="hs-identifier">challengeToAuthority</span></a></a><span> </span><a name="local-6989586621679084235"><a href="#local-6989586621679084235"><span class="hs-identifier">uri</span></a></a><span> </span><a name="local-6989586621679084236"><a href="#local-6989586621679084236"><span class="hs-identifier">ch</span></a></a><span>
</span><a name="line-345"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084237"><span class="hs-identifier hs-var">answerable</span></a><span> </span><a href="#local-6989586621679084236"><span class="hs-identifier hs-var">ch</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-346"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-347"></a><span>      </span><span class="hs-comment">-- prompt user for authority</span><span>
</span><a name="line-348"></a><span>    </span><a name="local-6989586621679084252"><a href="#local-6989586621679084252"><span class="hs-identifier">prompt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getAuthorityGen"><span class="hs-identifier hs-var">getAuthorityGen</span></a><span>
</span><a name="line-349"></a><span>    </span><a name="local-6989586621679084253"><a href="#local-6989586621679084253"><span class="hs-identifier">userdetails</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679084252"><span class="hs-identifier hs-var">prompt</span></a><span> </span><a href="#local-6989586621679084235"><span class="hs-identifier hs-var">uri</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">chRealm</span><span> </span><a href="#local-6989586621679084236"><span class="hs-identifier hs-var">ch</span></a><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084253"><span class="hs-identifier hs-var">userdetails</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-351"></a><span>     </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-352"></a><span>     </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679084254"><a href="#local-6989586621679084254"><span class="hs-identifier">u</span></a></a><span class="hs-special">,</span><a name="local-6989586621679084255"><a href="#local-6989586621679084255"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679084238"><span class="hs-identifier hs-var">buildAuth</span></a><span> </span><a href="#local-6989586621679084236"><span class="hs-identifier hs-var">ch</span></a><span> </span><a href="#local-6989586621679084254"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679084255"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-identifier">answerable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Auth.html#Challenge"><span class="hs-identifier hs-type">Challenge</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-355"></a><span>  </span><a name="local-6989586621679084237"><a href="#local-6989586621679084237"><span class="hs-identifier">answerable</span></a></a><span> </span><a href="Network.HTTP.Auth.html#ChalBasic"><span class="hs-identifier hs-var">ChalBasic</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-identifier">answerable</span><span> </span><a name="local-6989586621679084239"><a href="#local-6989586621679084239"><span class="hs-identifier">chall</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">chAlgorithm</span><span> </span><a href="#local-6989586621679084239"><span class="hs-identifier hs-var">chall</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="Network.HTTP.Auth.html#AlgMD5"><span class="hs-identifier hs-var">AlgMD5</span></a><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-identifier">buildAuth</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Auth.html#Challenge"><span class="hs-identifier hs-type">Challenge</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span>
</span><a name="line-359"></a><span>  </span><a name="local-6989586621679084238"><a href="#local-6989586621679084238"><span class="hs-identifier">buildAuth</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#ChalBasic"><span class="hs-identifier hs-var">ChalBasic</span></a><span> </span><a name="local-6989586621679084240"><a href="#local-6989586621679084240"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679084241"><a href="#local-6989586621679084241"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679084242"><a href="#local-6989586621679084242"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-360"></a><span>       </span><a href="Network.HTTP.Auth.html#AuthBasic"><span class="hs-identifier hs-var">AuthBasic</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">auSite</span><span class="hs-glyph">=</span><a href="#local-6989586621679084235"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-361"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auRealm</span><span class="hs-glyph">=</span><a href="#local-6989586621679084240"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-362"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auUsername</span><span class="hs-glyph">=</span><a href="#local-6989586621679084241"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-363"></a><span>                 </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auPassword</span><span class="hs-glyph">=</span><a href="#local-6989586621679084242"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-364"></a><span>                 </span><span class="hs-special">}</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span>    </span><span class="hs-comment">-- note to self: this is a pretty stupid operation</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-comment">-- to perform isn't it? ChalX and AuthX are so very</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-comment">-- similar.</span><span>
</span><a name="line-369"></a><span>  </span><span class="hs-identifier">buildAuth</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#ChalDigest"><span class="hs-identifier hs-var">ChalDigest</span></a><span> </span><a name="local-6989586621679084243"><a href="#local-6989586621679084243"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679084244"><a href="#local-6989586621679084244"><span class="hs-identifier">d</span></a></a><span> </span><a name="local-6989586621679084245"><a href="#local-6989586621679084245"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621679084246"><a href="#local-6989586621679084246"><span class="hs-identifier">o</span></a></a><span> </span><a name="local-6989586621679084247"><a href="#local-6989586621679084247"><span class="hs-identifier">_stale</span></a></a><span> </span><a name="local-6989586621679084248"><a href="#local-6989586621679084248"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679084249"><a href="#local-6989586621679084249"><span class="hs-identifier">q</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679084250"><a href="#local-6989586621679084250"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679084251"><a href="#local-6989586621679084251"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-370"></a><span>            </span><a href="Network.HTTP.Auth.html#AuthDigest"><span class="hs-identifier hs-var">AuthDigest</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">auRealm</span><span class="hs-glyph">=</span><a href="#local-6989586621679084243"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-371"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auUsername</span><span class="hs-glyph">=</span><a href="#local-6989586621679084250"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-372"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auPassword</span><span class="hs-glyph">=</span><a href="#local-6989586621679084251"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-373"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auDomain</span><span class="hs-glyph">=</span><a href="#local-6989586621679084244"><span class="hs-identifier hs-var">d</span></a><span>
</span><a name="line-374"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auNonce</span><span class="hs-glyph">=</span><a href="#local-6989586621679084245"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-375"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auOpaque</span><span class="hs-glyph">=</span><a href="#local-6989586621679084246"><span class="hs-identifier hs-var">o</span></a><span>
</span><a name="line-376"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auAlgorithm</span><span class="hs-glyph">=</span><a href="#local-6989586621679084248"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-377"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">auQop</span><span class="hs-glyph">=</span><a href="#local-6989586621679084249"><span class="hs-identifier hs-var">q</span></a><span>
</span><a name="line-378"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-382"></a><span class="hs-comment">------------------ Browser State Actions -------------------------</span><span>
</span><a name="line-383"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-384"></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- | @BrowserState@ is the (large) record type tracking the current</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- settings of the browser.</span><span>
</span><a name="line-388"></a><span class="hs-keyword">data</span><span> </span><a name="BrowserState"><a href="Network.Browser.html#BrowserState"><span class="hs-identifier">BrowserState</span></a></a><span> </span><a name="local-6989586621679084134"><a href="#local-6989586621679084134"><span class="hs-identifier">connection</span></a></a><span>
</span><a name="line-389"></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BS"><a href="Network.Browser.html#BS"><span class="hs-identifier">BS</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="bsErr"><a href="Network.Browser.html#bsErr"><span class="hs-identifier">bsErr</span></a></a><span class="hs-special">,</span><span> </span><a name="bsOut"><a href="Network.Browser.html#bsOut"><span class="hs-identifier">bsOut</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-390"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsCookies"><a href="Network.Browser.html#bsCookies"><span class="hs-identifier">bsCookies</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span class="hs-special">]</span><span>
</span><a name="line-391"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsCookieFilter"><a href="Network.Browser.html#bsCookieFilter"><span class="hs-identifier">bsCookieFilter</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Cookie.html#Cookie"><span class="hs-identifier hs-type">Cookie</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-392"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsAuthorityGen"><a href="Network.Browser.html#bsAuthorityGen"><span class="hs-identifier">bsAuthorityGen</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsAuthorities"><a href="Network.Browser.html#bsAuthorities"><span class="hs-identifier">bsAuthorities</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Auth.html#Authority"><span class="hs-identifier hs-type">Authority</span></a><span class="hs-special">]</span><span>
</span><a name="line-394"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsAllowRedirects"><a href="Network.Browser.html#bsAllowRedirects"><span class="hs-identifier">bsAllowRedirects</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-395"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsAllowBasicAuth"><a href="Network.Browser.html#bsAllowBasicAuth"><span class="hs-identifier">bsAllowBasicAuth</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-396"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsMaxRedirects"><a href="Network.Browser.html#bsMaxRedirects"><span class="hs-identifier">bsMaxRedirects</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-397"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsMaxErrorRetries"><a href="Network.Browser.html#bsMaxErrorRetries"><span class="hs-identifier">bsMaxErrorRetries</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-398"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsMaxAuthAttempts"><a href="Network.Browser.html#bsMaxAuthAttempts"><span class="hs-identifier">bsMaxAuthAttempts</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-399"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsMaxPoolSize"><a href="Network.Browser.html#bsMaxPoolSize"><span class="hs-identifier">bsMaxPoolSize</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-400"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsConnectionPool"><a href="Network.Browser.html#bsConnectionPool"><span class="hs-identifier">bsConnectionPool</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679084134"><span class="hs-identifier hs-type">connection</span></a><span class="hs-special">]</span><span>
</span><a name="line-401"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsCheckProxy"><a href="Network.Browser.html#bsCheckProxy"><span class="hs-identifier">bsCheckProxy</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-402"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsProxy"><a href="Network.Browser.html#bsProxy"><span class="hs-identifier">bsProxy</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span>
</span><a name="line-403"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsDebug"><a href="Network.Browser.html#bsDebug"><span class="hs-identifier">bsDebug</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-404"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsEvent"><a href="Network.Browser.html#bsEvent"><span class="hs-identifier">bsEvent</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier hs-type">BrowserEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084134"><span class="hs-identifier hs-type">connection</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-405"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsRequestID"><a href="Network.Browser.html#bsRequestID"><span class="hs-identifier">bsRequestID</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a><span>
</span><a name="line-406"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="bsUserAgent"><a href="Network.Browser.html#bsUserAgent"><span class="hs-identifier">bsUserAgent</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-407"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679084932"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-410"></a><span>    </span><a name="local-8214565720323790731"><span class="hs-identifier">show</span></a><span> </span><a name="local-6989586621679084933"><a href="#local-6989586621679084933"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-string">&quot;BrowserState { &quot;</span><span> </span><span>
</span><a name="line-411"></a><span>            </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">shows</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bsCookies</span><span> </span><a href="#local-6989586621679084933"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;\n&quot;</span><span>
</span><a name="line-412"></a><span>           </span><span class="hs-comment">{- ++ show (bsAuthorities bs) ++ &quot;\n&quot;-}</span><span>
</span><a name="line-413"></a><span>            </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;AllowRedirects: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">shows</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bsAllowRedirects</span><span> </span><a href="#local-6989586621679084933"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;} &quot;</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>
</span><a name="line-415"></a><span class="hs-comment">-- | @BrowserAction@ is the IO monad, but carrying along a 'BrowserState'.</span><span>
</span><a name="line-416"></a><span class="hs-keyword">newtype</span><span> </span><a name="BrowserAction"><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier">BrowserAction</span></a></a><span> </span><a name="local-6989586621679083804"><a href="#local-6989586621679083804"><span class="hs-identifier">conn</span></a></a><span> </span><a name="local-6989586621679083805"><a href="#local-6989586621679083805"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-417"></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BA"><a href="Network.Browser.html#BA"><span class="hs-identifier">BA</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="unBA"><a href="Network.Browser.html#unBA"><span class="hs-identifier">unBA</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">StateT</span><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679083804"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679083805"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-418"></a><span class="hs-cpp">#ifdef MTL1</span><span>
</span><a name="line-419"></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadState</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">BrowserState</span><span> </span><span class="hs-identifier">conn</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">BrowserAction</span><span> </span><span class="hs-identifier">conn</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-422"></a><span>  </span><span class="hs-identifier">pure</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-special">(</span><span class="hs-operator">&lt;*&gt;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ap</span><span>
</span><a name="line-424"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-425"></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadState</span><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679083804"><span class="hs-identifier hs-type">conn</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-427"></a><span>
</span><a name="line-428"></a><span class="hs-identifier">runBA</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679084171"><span class="hs-identifier hs-type">conn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084171"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679084172"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679084172"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-429"></a><a name="runBA"><a href="Network.Browser.html#runBA"><span class="hs-identifier">runBA</span></a></a><span> </span><a name="local-6989586621679084256"><a href="#local-6989586621679084256"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">evalStateT</span><span> </span><a href="#local-6989586621679084256"><span class="hs-identifier hs-var">bs</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unBA</span><span>
</span><a name="line-430"></a><span>
</span><a name="line-431"></a><span class="hs-comment">-- | @browse act@ is the toplevel action to perform a 'BrowserAction'.</span><span>
</span><a name="line-432"></a><span class="hs-comment">-- Example use: @browse (request (getRequest yourURL))@.</span><span>
</span><a name="line-433"></a><span class="hs-identifier">browse</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084169"><span class="hs-identifier hs-type">conn</span></a><span> </span><a href="#local-6989586621679084170"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679084170"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-434"></a><a name="browse"><a href="Network.Browser.html#browse"><span class="hs-identifier">browse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#runBA"><span class="hs-identifier hs-var">runBA</span></a><span> </span><a href="Network.Browser.html#defaultBrowserState"><span class="hs-identifier hs-var">defaultBrowserState</span></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span class="hs-comment">-- | The default browser state has the settings </span><span>
</span><a name="line-437"></a><span class="hs-identifier">defaultBrowserState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679084168"><span class="hs-identifier hs-type">t</span></a><span>
</span><a name="line-438"></a><a name="defaultBrowserState"><a href="Network.Browser.html#defaultBrowserState"><span class="hs-identifier">defaultBrowserState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084257"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-439"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-440"></a><span>   </span><a name="local-6989586621679084257"><a href="#local-6989586621679084257"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#BS"><span class="hs-identifier hs-var">BS</span></a><span>
</span><a name="line-441"></a><span>     </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsErr</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span>
</span><a name="line-442"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsOut</span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">putStrLn</span><span>
</span><a name="line-443"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsCookies</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-444"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsCookieFilter</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#defaultCookieFilter"><span class="hs-identifier hs-var">defaultCookieFilter</span></a><span>
</span><a name="line-445"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsAuthorityGen</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679084258"><a href="#local-6989586621679084258"><span class="hs-identifier">_uri</span></a></a><span> </span><a name="local-6989586621679084259"><a href="#local-6989586621679084259"><span class="hs-identifier">_realm</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-446"></a><span>          </span><span class="hs-identifier">bsErr</span><span> </span><a href="#local-6989586621679084257"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-string">&quot;No action for prompting/generating user+password credentials provided (use: setAuthorityGen); returning Nothing&quot;</span><span>
</span><a name="line-447"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-448"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsAuthorities</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-449"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsAllowRedirects</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-450"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsAllowBasicAuth</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-451"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsMaxRedirects</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-452"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsMaxErrorRetries</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-453"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsMaxAuthAttempts</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-454"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsMaxPoolSize</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-455"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-456"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsCheckProxy</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#defaultAutoProxyDetect"><span class="hs-identifier hs-var">defaultAutoProxyDetect</span></a><span>
</span><a name="line-457"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsProxy</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Proxy.html#noProxy"><span class="hs-identifier hs-var">noProxy</span></a><span>
</span><a name="line-458"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsDebug</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span>
</span><a name="line-459"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsEvent</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-460"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsRequestID</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-461"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsUserAgent</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-462"></a><span>     </span><span class="hs-special">}</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span class="hs-pragma">{-# DEPRECATED getBrowserState &quot;Use Control.Monad.State.get instead.&quot; #-}</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- | @getBrowserState@ returns the current browser config. Useful</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- for restoring state across 'BrowserAction's.</span><span>
</span><a name="line-467"></a><span class="hs-identifier">getBrowserState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084167"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679084167"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-468"></a><a name="getBrowserState"><a href="Network.Browser.html#getBrowserState"><span class="hs-identifier">getBrowserState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-469"></a><span>
</span><a name="line-470"></a><span class="hs-comment">-- | @withBrowserAction st act@ performs @act@ with 'BrowserState' @st@.</span><span>
</span><a name="line-471"></a><span class="hs-identifier">withBrowserState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserState"><span class="hs-identifier hs-type">BrowserState</span></a><span> </span><a href="#local-6989586621679084165"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084165"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679084166"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084165"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679084166"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-472"></a><a name="withBrowserState"><a href="Network.Browser.html#withBrowserState"><span class="hs-identifier">withBrowserState</span></a></a><span> </span><a name="local-6989586621679084260"><a href="#local-6989586621679084260"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#BA"><span class="hs-identifier hs-var">BA</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">withStateT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621679084260"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unBA</span><span>
</span><a name="line-473"></a><span>
</span><a name="line-474"></a><span class="hs-comment">-- | @nextRequest act@ performs the browser action @act@ as</span><span>
</span><a name="line-475"></a><span class="hs-comment">-- the next request, i.e., setting up a new request context</span><span>
</span><a name="line-476"></a><span class="hs-comment">-- before doing so.</span><span>
</span><a name="line-477"></a><span class="hs-identifier">nextRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084163"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679084164"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084163"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679084164"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-478"></a><a name="nextRequest"><a href="Network.Browser.html#nextRequest"><span class="hs-identifier">nextRequest</span></a></a><span> </span><a name="local-6989586621679084261"><a href="#local-6989586621679084261"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-479"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084262"><a href="#local-6989586621679084262"><span class="hs-identifier">updReqID</span></a></a><span> </span><a name="local-6989586621679084263"><a href="#local-6989586621679084263"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><a name="line-480"></a><span>       </span><span class="hs-keyword">let</span><span> </span><span>
</span><a name="line-481"></a><span>        </span><a name="local-6989586621679084264"><a href="#local-6989586621679084264"><span class="hs-identifier">rid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bsRequestID</span><span> </span><a href="#local-6989586621679084263"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>       </span><span class="hs-keyword">in</span><span>
</span><a name="line-483"></a><span>       </span><a href="#local-6989586621679084264"><span class="hs-identifier hs-var">rid</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679084263"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">{</span><span class="hs-identifier">bsRequestID</span><span class="hs-glyph">=</span><a href="#local-6989586621679084264"><span class="hs-identifier hs-var">rid</span></a><span class="hs-special">}</span><span>
</span><a name="line-484"></a><span>  </span><span class="hs-identifier hs-var">modify</span><span> </span><a href="#local-6989586621679084262"><span class="hs-identifier hs-var">updReqID</span></a><span>
</span><a name="line-485"></a><span>  </span><a href="#local-6989586621679084261"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-comment">-- | Lifts an IO action into the 'BrowserAction' monad.</span><span>
</span><a name="line-488"></a><span class="hs-pragma">{-# DEPRECATED ioAction &quot;Use Control.Monad.Trans.liftIO instead.&quot; #-}</span><span>
</span><a name="line-489"></a><span class="hs-identifier">ioAction</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679084161"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084162"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679084161"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-490"></a><a name="ioAction"><a href="Network.Browser.html#ioAction"><span class="hs-identifier">ioAction</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span class="hs-comment">-- | @setErrHandler@ sets the IO action to call when</span><span>
</span><a name="line-493"></a><span class="hs-comment">-- the browser reports running errors. To disable any</span><span>
</span><a name="line-494"></a><span class="hs-comment">-- such, set it to @const (return ())@.</span><span>
</span><a name="line-495"></a><span class="hs-identifier">setErrHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084160"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-496"></a><a name="setErrHandler"><a href="Network.Browser.html#setErrHandler"><span class="hs-identifier">setErrHandler</span></a></a><span> </span><a name="local-6989586621679084265"><a href="#local-6989586621679084265"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084266"><a href="#local-6989586621679084266"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084266"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsErr</span><span class="hs-glyph">=</span><a href="#local-6989586621679084265"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-497"></a><span>
</span><a name="line-498"></a><span class="hs-comment">-- | @setOutHandler@ sets the IO action to call when</span><span>
</span><a name="line-499"></a><span class="hs-comment">-- the browser chatters info on its running. To disable any</span><span>
</span><a name="line-500"></a><span class="hs-comment">-- such, set it to @const (return ())@.</span><span>
</span><a name="line-501"></a><span class="hs-identifier">setOutHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084159"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-502"></a><a name="setOutHandler"><a href="Network.Browser.html#setOutHandler"><span class="hs-identifier">setOutHandler</span></a></a><span> </span><a name="local-6989586621679084267"><a href="#local-6989586621679084267"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084268"><a href="#local-6989586621679084268"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084268"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsOut</span><span class="hs-glyph">=</span><a href="#local-6989586621679084267"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-503"></a><span>
</span><a name="line-504"></a><span class="hs-identifier">out</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">err</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084158"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-505"></a><a name="out"><a href="Network.Browser.html#out"><span class="hs-identifier">out</span></a></a><span> </span><a name="local-6989586621679084269"><a href="#local-6989586621679084269"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679084270"><a href="#local-6989586621679084270"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsOut</span><span> </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679084270"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679084269"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-506"></a><a name="err"><a href="Network.Browser.html#err"><span class="hs-identifier">err</span></a></a><span> </span><a name="local-6989586621679084271"><a href="#local-6989586621679084271"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621679084272"><a href="#local-6989586621679084272"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsErr</span><span> </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679084272"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679084271"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-507"></a><span>
</span><a name="line-508"></a><span class="hs-comment">-- | @setAllowRedirects onOff@ toggles the willingness to</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- follow redirects (HTTP responses with 3xx status codes).</span><span>
</span><a name="line-510"></a><span class="hs-identifier">setAllowRedirects</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084157"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-511"></a><a name="setAllowRedirects"><a href="Network.Browser.html#setAllowRedirects"><span class="hs-identifier">setAllowRedirects</span></a></a><span> </span><a name="local-6989586621679084273"><a href="#local-6989586621679084273"><span class="hs-identifier">bl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084274"><a href="#local-6989586621679084274"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084274"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">bsAllowRedirects</span><span class="hs-glyph">=</span><a href="#local-6989586621679084273"><span class="hs-identifier hs-var">bl</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-512"></a><span>
</span><a name="line-513"></a><span class="hs-comment">-- | @getAllowRedirects@ returns current setting of the do-chase-redirects flag.</span><span>
</span><a name="line-514"></a><span class="hs-identifier">getAllowRedirects</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084156"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-515"></a><a name="getAllowRedirects"><a href="Network.Browser.html#getAllowRedirects"><span class="hs-identifier">getAllowRedirects</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsAllowRedirects</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-comment">-- | @setMaxRedirects maxCount@ sets the maxiumum number of forwarding hops</span><span>
</span><a name="line-518"></a><span class="hs-comment">-- we are willing to jump through. A no-op if the count is negative; if zero,</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- the max is set to whatever default applies. Notice that setting the max</span><span>
</span><a name="line-520"></a><span class="hs-comment">-- redirects count does /not/ enable following of redirects itself; use</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- 'setAllowRedirects' to do so.</span><span>
</span><a name="line-522"></a><span class="hs-identifier">setMaxRedirects</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084155"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-523"></a><a name="setMaxRedirects"><a href="Network.Browser.html#setMaxRedirects"><span class="hs-identifier">setMaxRedirects</span></a></a><span> </span><a name="local-6989586621679084275"><a href="#local-6989586621679084275"><span class="hs-identifier">c</span></a></a><span> </span><span>
</span><a name="line-524"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621679084275"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-525"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084276"><a href="#local-6989586621679084276"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084276"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsMaxRedirects</span><span class="hs-glyph">=</span><a href="#local-6989586621679084275"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-comment">-- | @getMaxRedirects@ returns the current setting for the max-redirect count.</span><span>
</span><a name="line-528"></a><span class="hs-comment">-- If @Nothing@, the &quot;Network.Browser&quot;'s default is used.</span><span>
</span><a name="line-529"></a><span class="hs-identifier">getMaxRedirects</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084154"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-530"></a><a name="getMaxRedirects"><a href="Network.Browser.html#getMaxRedirects"><span class="hs-identifier">getMaxRedirects</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsMaxRedirects</span><span>
</span><a name="line-531"></a><span>
</span><a name="line-532"></a><span class="hs-comment">-- | @setMaxPoolSize maxCount@ sets the maximum size of the connection pool</span><span>
</span><a name="line-533"></a><span class="hs-comment">-- that is used to cache connections between requests</span><span>
</span><a name="line-534"></a><span class="hs-identifier">setMaxPoolSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084153"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-535"></a><a name="setMaxPoolSize"><a href="Network.Browser.html#setMaxPoolSize"><span class="hs-identifier">setMaxPoolSize</span></a></a><span> </span><a name="local-6989586621679084277"><a href="#local-6989586621679084277"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084278"><a href="#local-6989586621679084278"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084278"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsMaxPoolSize</span><span class="hs-glyph">=</span><a href="#local-6989586621679084277"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-536"></a><span>
</span><a name="line-537"></a><span class="hs-comment">-- | @getMaxPoolSize@ gets the maximum size of the connection pool</span><span>
</span><a name="line-538"></a><span class="hs-comment">-- that is used to cache connections between requests.</span><span>
</span><a name="line-539"></a><span class="hs-comment">-- If @Nothing@, the &quot;Network.Browser&quot;'s default is used.</span><span>
</span><a name="line-540"></a><span class="hs-identifier">getMaxPoolSize</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084152"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span>
</span><a name="line-541"></a><a name="getMaxPoolSize"><a href="Network.Browser.html#getMaxPoolSize"><span class="hs-identifier">getMaxPoolSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsMaxPoolSize</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-comment">-- | @setProxy p@ will disable proxy usage if @p@ is @NoProxy@.</span><span>
</span><a name="line-544"></a><span class="hs-comment">-- If @p@ is @Proxy proxyURL mbAuth@, then @proxyURL@ is interpreted</span><span>
</span><a name="line-545"></a><span class="hs-comment">-- as the URL of the proxy to use, possibly authenticating via </span><span>
</span><a name="line-546"></a><span class="hs-comment">-- 'Authority' information in @mbAuth@.</span><span>
</span><a name="line-547"></a><span class="hs-identifier">setProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084151"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-548"></a><a name="setProxy"><a href="Network.Browser.html#setProxy"><span class="hs-identifier">setProxy</span></a></a><span> </span><a name="local-6989586621679084279"><a href="#local-6989586621679084279"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-549"></a><span>   </span><span class="hs-comment">-- Note: if user _explicitly_ sets the proxy, we turn</span><span>
</span><a name="line-550"></a><span>   </span><span class="hs-comment">-- off any auto-detection of proxies.</span><span>
</span><a name="line-551"></a><span>  </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084280"><a href="#local-6989586621679084280"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084280"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">bsProxy</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084279"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">bsCheckProxy</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-552"></a><span>
</span><a name="line-553"></a><span class="hs-comment">-- | @getProxy@ returns the current proxy settings. If</span><span>
</span><a name="line-554"></a><span class="hs-comment">-- the auto-proxy flag is set to @True@, @getProxy@ will</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- perform the necessary </span><span>
</span><a name="line-556"></a><span class="hs-identifier">getProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084150"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a><span>
</span><a name="line-557"></a><a name="getProxy"><a href="Network.Browser.html#getProxy"><span class="hs-identifier">getProxy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-558"></a><span>  </span><a name="local-6989586621679084281"><a href="#local-6989586621679084281"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsProxy</span><span>
</span><a name="line-559"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084281"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-560"></a><span>      </span><span class="hs-comment">-- Note: if there is a proxy, no need to perform any auto-detect.</span><span>
</span><a name="line-561"></a><span>      </span><span class="hs-comment">-- Presumably this is the user's explicit and preferred proxy server.</span><span>
</span><a name="line-562"></a><span>    </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084281"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-563"></a><span>    </span><a href="Network.HTTP.Proxy.html#NoProxy"><span class="hs-identifier hs-var">NoProxy</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-564"></a><span>     </span><a name="local-6989586621679084282"><a href="#local-6989586621679084282"><span class="hs-identifier">flg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsCheckProxy</span><span>
</span><a name="line-565"></a><span>     </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621679084282"><span class="hs-identifier hs-var">flg</span></a><span>
</span><a name="line-566"></a><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084281"><span class="hs-identifier hs-var">p</span></a><span> </span><span>
</span><a name="line-567"></a><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-568"></a><span>       </span><a name="local-6989586621679084283"><a href="#local-6989586621679084283"><span class="hs-identifier">np</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.HTTP.Proxy.html#fetchProxy"><span class="hs-identifier hs-var">fetchProxy</span></a><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-comment">{-issue warning on stderr if ill-formed...-}</span><span>
</span><a name="line-569"></a><span>        </span><span class="hs-comment">-- note: this resets the check-proxy flag; a one-off affair.</span><span>
</span><a name="line-570"></a><span>       </span><a href="Network.Browser.html#setProxy"><span class="hs-identifier hs-var">setProxy</span></a><span> </span><a href="#local-6989586621679084283"><span class="hs-identifier hs-var">np</span></a><span>
</span><a name="line-571"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084283"><span class="hs-identifier hs-var">np</span></a><span>
</span><a name="line-572"></a><span>
</span><a name="line-573"></a><span class="hs-comment">-- | @setCheckForProxy flg@ sets the one-time check for proxy</span><span>
</span><a name="line-574"></a><span class="hs-comment">-- flag to @flg@. If @True@, the session will try to determine</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- the proxy server is locally configured. See 'Network.HTTP.Proxy.fetchProxy'</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- for details of how this done.</span><span>
</span><a name="line-577"></a><span class="hs-identifier">setCheckForProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084149"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-578"></a><a name="setCheckForProxy"><a href="Network.Browser.html#setCheckForProxy"><span class="hs-identifier">setCheckForProxy</span></a></a><span> </span><a name="local-6989586621679084284"><a href="#local-6989586621679084284"><span class="hs-identifier">flg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679084285"><a href="#local-6989586621679084285"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084285"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsCheckProxy</span><span class="hs-glyph">=</span><a href="#local-6989586621679084284"><span class="hs-identifier hs-var">flg</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>
</span><a name="line-580"></a><span class="hs-comment">-- | @getCheckForProxy@ returns the current check-proxy setting.</span><span>
</span><a name="line-581"></a><span class="hs-comment">-- Notice that this may not be equal to @True@ if the session has</span><span>
</span><a name="line-582"></a><span class="hs-comment">-- set it to that via 'setCheckForProxy' and subsequently performed</span><span>
</span><a name="line-583"></a><span class="hs-comment">-- some HTTP protocol interactions. i.e., the flag return represents</span><span>
</span><a name="line-584"></a><span class="hs-comment">-- whether a proxy will be checked for again before any future protocol</span><span>
</span><a name="line-585"></a><span class="hs-comment">-- interactions.</span><span>
</span><a name="line-586"></a><span class="hs-identifier">getCheckForProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084148"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-587"></a><a name="getCheckForProxy"><a href="Network.Browser.html#getCheckForProxy"><span class="hs-identifier">getCheckForProxy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsCheckProxy</span><span>
</span><a name="line-588"></a><span>
</span><a name="line-589"></a><span class="hs-comment">-- | @setDebugLog mbFile@ turns off debug logging iff @mbFile@</span><span>
</span><a name="line-590"></a><span class="hs-comment">-- is @Nothing@. If set to @Just fStem@, logs of browser activity</span><span>
</span><a name="line-591"></a><span class="hs-comment">-- is appended to files of the form @fStem-url-authority@, i.e.,</span><span>
</span><a name="line-592"></a><span class="hs-comment">-- @fStem@ is just the prefix for a set of log files, one per host/authority.</span><span>
</span><a name="line-593"></a><span class="hs-identifier">setDebugLog</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084147"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-594"></a><a name="setDebugLog"><a href="Network.Browser.html#setDebugLog"><span class="hs-identifier">setDebugLog</span></a></a><span> </span><a name="local-6989586621679084286"><a href="#local-6989586621679084286"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084287"><a href="#local-6989586621679084287"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084287"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">bsDebug</span><span class="hs-glyph">=</span><a href="#local-6989586621679084286"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-595"></a><span>
</span><a name="line-596"></a><span class="hs-comment">-- | @setUserAgent ua@ sets the current @User-Agent:@ string to @ua@. It</span><span>
</span><a name="line-597"></a><span class="hs-comment">-- will be used if no explicit user agent header is found in subsequent requests.</span><span>
</span><a name="line-598"></a><span class="hs-comment">--</span><span>
</span><a name="line-599"></a><span class="hs-comment">-- A common form of user agent string is @\&quot;name\/version (details)\&quot;@. For</span><span>
</span><a name="line-600"></a><span class="hs-comment">-- example @\&quot;cabal-install/0.10.2 (HTTP 4000.1.2)\&quot;@. Including the version</span><span>
</span><a name="line-601"></a><span class="hs-comment">-- of this HTTP package can be helpful if you ever need to track down HTTP</span><span>
</span><a name="line-602"></a><span class="hs-comment">-- compatability quirks. This version is available via 'httpPackageVersion'.</span><span>
</span><a name="line-603"></a><span class="hs-comment">-- For more info see &lt;http://en.wikipedia.org/wiki/User_agent&gt;.</span><span>
</span><a name="line-604"></a><span class="hs-comment">--</span><span>
</span><a name="line-605"></a><span class="hs-identifier">setUserAgent</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084146"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-606"></a><a name="setUserAgent"><a href="Network.Browser.html#setUserAgent"><span class="hs-identifier">setUserAgent</span></a></a><span> </span><a name="local-6989586621679084288"><a href="#local-6989586621679084288"><span class="hs-identifier">ua</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084289"><a href="#local-6989586621679084289"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084289"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">{</span><span class="hs-identifier">bsUserAgent</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679084288"><span class="hs-identifier hs-var">ua</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-607"></a><span>
</span><a name="line-608"></a><span class="hs-comment">-- | @getUserAgent@ returns the current @User-Agent:@ default string.</span><span>
</span><a name="line-609"></a><span class="hs-identifier">getUserAgent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084145"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-610"></a><a name="getUserAgent"><a href="Network.Browser.html#getUserAgent"><span class="hs-identifier">getUserAgent</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-611"></a><span>  </span><a name="local-6989586621679084290"><a href="#local-6989586621679084290"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsUserAgent</span><span>
</span><a name="line-612"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="Network.HTTP.Base.html#defaultUserAgent"><span class="hs-identifier hs-var">defaultUserAgent</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-6989586621679084290"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-613"></a><span>
</span><a name="line-614"></a><span class="hs-comment">-- | @RequestState@ is an internal tallying type keeping track of various </span><span>
</span><a name="line-615"></a><span class="hs-comment">-- per-connection counters, like the number of authorization attempts and </span><span>
</span><a name="line-616"></a><span class="hs-comment">-- forwards we've gone through.</span><span>
</span><a name="line-617"></a><span class="hs-keyword">data</span><span> </span><a name="RequestState"><a href="Network.Browser.html#RequestState"><span class="hs-identifier">RequestState</span></a></a><span> </span><span>
</span><a name="line-618"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="RequestState"><a href="Network.Browser.html#RequestState"><span class="hs-identifier">RequestState</span></a></a><span>
</span><a name="line-619"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="reqDenies"><a href="Network.Browser.html#reqDenies"><span class="hs-identifier">reqDenies</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>   </span><span class="hs-comment">-- ^ number of 401 responses so far</span><span>
</span><a name="line-620"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="reqRedirects"><a href="Network.Browser.html#reqRedirects"><span class="hs-identifier">reqRedirects</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>   </span><span class="hs-comment">-- ^ number of redirects so far</span><span>
</span><a name="line-621"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="reqRetries"><a href="Network.Browser.html#reqRetries"><span class="hs-identifier">reqRetries</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>   </span><span class="hs-comment">-- ^ number of retries so far</span><span>
</span><a name="line-622"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="reqStopOnDeny"><a href="Network.Browser.html#reqStopOnDeny"><span class="hs-identifier">reqStopOnDeny</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>  </span><span class="hs-comment">-- ^ whether to pre-empt 401 response</span><span>
</span><a name="line-623"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-624"></a><span>
</span><a name="line-625"></a><span class="hs-keyword">type</span><span> </span><a name="RequestID"><a href="Network.Browser.html#RequestID"><span class="hs-identifier">RequestID</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- yeah, it will wrap around.</span><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span class="hs-identifier">nullRequestState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#RequestState"><span class="hs-identifier hs-type">RequestState</span></a><span>
</span><a name="line-628"></a><a name="nullRequestState"><a href="Network.Browser.html#nullRequestState"><span class="hs-identifier">nullRequestState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#RequestState"><span class="hs-identifier hs-var">RequestState</span></a><span>
</span><a name="line-629"></a><span>      </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">reqDenies</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-630"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqRedirects</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-631"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqRetries</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-632"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqStopOnDeny</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-633"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span class="hs-comment">-- | @BrowserEvent@ is the event record type that a user-defined handler, set</span><span>
</span><a name="line-636"></a><span class="hs-comment">-- via 'setEventHandler', will be passed. It indicates various state changes</span><span>
</span><a name="line-637"></a><span class="hs-comment">-- encountered in the processing of a given 'RequestID', along with timestamps</span><span>
</span><a name="line-638"></a><span class="hs-comment">-- at which they occurred.</span><span>
</span><a name="line-639"></a><span class="hs-keyword">data</span><span> </span><a name="BrowserEvent"><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier">BrowserEvent</span></a></a><span>
</span><a name="line-640"></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="BrowserEvent"><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier">BrowserEvent</span></a></a><span>
</span><a name="line-641"></a><span>      </span><span class="hs-special">{</span><span> </span><a name="browserTimestamp"><a href="Network.Browser.html#browserTimestamp"><span class="hs-identifier">browserTimestamp</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">UTCTime</span><span>
</span><a name="line-642"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="browserRequestID"><a href="Network.Browser.html#browserRequestID"><span class="hs-identifier">browserRequestID</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a><span>
</span><a name="line-643"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="browserRequestURI"><a href="Network.Browser.html#browserRequestURI"><span class="hs-identifier">browserRequestURI</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-comment">{-URI-}</span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-644"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="browserEventType"><a href="Network.Browser.html#browserEventType"><span class="hs-identifier">browserEventType</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserEventType"><span class="hs-identifier hs-type">BrowserEventType</span></a><span>
</span><a name="line-645"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-646"></a><span>
</span><a name="line-647"></a><span class="hs-comment">-- | 'BrowserEventType' is the enumerated list of events that the browser</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- internals will report to a user-defined event handler.</span><span>
</span><a name="line-649"></a><span class="hs-keyword">data</span><span> </span><a name="BrowserEventType"><a href="Network.Browser.html#BrowserEventType"><span class="hs-identifier">BrowserEventType</span></a></a><span>
</span><a name="line-650"></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="OpenConnection"><a href="Network.Browser.html#OpenConnection"><span class="hs-identifier">OpenConnection</span></a></a><span>
</span><a name="line-651"></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="ReuseConnection"><a href="Network.Browser.html#ReuseConnection"><span class="hs-identifier">ReuseConnection</span></a></a><span>
</span><a name="line-652"></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="RequestSent"><a href="Network.Browser.html#RequestSent"><span class="hs-identifier">RequestSent</span></a></a><span>
</span><a name="line-653"></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="ResponseEnd"><a href="Network.Browser.html#ResponseEnd"><span class="hs-identifier">ResponseEnd</span></a></a><span> </span><a href="Network.HTTP.Base.html#ResponseData"><span class="hs-identifier hs-type">ResponseData</span></a><span>
</span><a name="line-654"></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="ResponseFinish"><a href="Network.Browser.html#ResponseFinish"><span class="hs-identifier">ResponseFinish</span></a></a><span>
</span><a name="line-655"></a><span class="hs-comment">{- not yet, you will have to determine these via the ResponseEnd event.
 | Redirect
 | AuthChallenge
 | AuthResponse
-}</span><span>
</span><a name="line-660"></a><span> </span><span>
</span><a name="line-661"></a><span class="hs-comment">-- | @setEventHandler onBrowserEvent@ configures event handling.</span><span>
</span><a name="line-662"></a><span class="hs-comment">-- If @onBrowserEvent@ is @Nothing@, event handling is turned off;</span><span>
</span><a name="line-663"></a><span class="hs-comment">-- setting it to @Just onEv@ causes the @onEv@ IO action to be</span><span>
</span><a name="line-664"></a><span class="hs-comment">-- notified of browser events during the processing of a request</span><span>
</span><a name="line-665"></a><span class="hs-comment">-- by the Browser pipeline.</span><span>
</span><a name="line-666"></a><span class="hs-identifier">setEventHandler</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier hs-type">BrowserEvent</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084144"><span class="hs-identifier hs-type">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084144"><span class="hs-identifier hs-type">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-667"></a><a name="setEventHandler"><a href="Network.Browser.html#setEventHandler"><span class="hs-identifier">setEventHandler</span></a></a><span> </span><a name="local-6989586621679084291"><a href="#local-6989586621679084291"><span class="hs-identifier">mbH</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084292"><a href="#local-6989586621679084292"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084292"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsEvent</span><span class="hs-glyph">=</span><a href="#local-6989586621679084291"><span class="hs-identifier hs-var">mbH</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span class="hs-identifier">buildBrowserEvent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserEventType"><span class="hs-identifier hs-type">BrowserEventType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">{-URI-}</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier hs-type">BrowserEvent</span></a><span>
</span><a name="line-670"></a><a name="buildBrowserEvent"><a href="Network.Browser.html#buildBrowserEvent"><span class="hs-identifier">buildBrowserEvent</span></a></a><span> </span><a name="local-6989586621679084293"><a href="#local-6989586621679084293"><span class="hs-identifier">bt</span></a></a><span> </span><a name="local-6989586621679084294"><a href="#local-6989586621679084294"><span class="hs-identifier">uri</span></a></a><span> </span><a name="local-6989586621679084295"><a href="#local-6989586621679084295"><span class="hs-identifier">reqID</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-671"></a><span>  </span><a name="local-6989586621679084324"><a href="#local-6989586621679084324"><span class="hs-identifier">ct</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-672"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Network.Browser.html#BrowserEvent"><span class="hs-identifier hs-var">BrowserEvent</span></a><span> </span><span>
</span><a name="line-673"></a><span>         </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">browserTimestamp</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084324"><span class="hs-identifier hs-var">ct</span></a><span>
</span><a name="line-674"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">browserRequestID</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084295"><span class="hs-identifier hs-var">reqID</span></a><span>
</span><a name="line-675"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">browserRequestURI</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084294"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-676"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">browserEventType</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084293"><span class="hs-identifier hs-var">bt</span></a><span>
</span><a name="line-677"></a><span>         </span><span class="hs-special">}</span><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span class="hs-identifier">reportEvent</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#BrowserEventType"><span class="hs-identifier hs-type">BrowserEventType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">{-URI-}</span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084143"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-680"></a><a name="reportEvent"><a href="Network.Browser.html#reportEvent"><span class="hs-identifier">reportEvent</span></a></a><span> </span><a name="local-6989586621679084325"><a href="#local-6989586621679084325"><span class="hs-identifier">bt</span></a></a><span> </span><a name="local-6989586621679084326"><a href="#local-6989586621679084326"><span class="hs-identifier">uri</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-681"></a><span>  </span><a name="local-6989586621679084327"><a href="#local-6989586621679084327"><span class="hs-identifier">st</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-682"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">bsEvent</span><span> </span><a href="#local-6989586621679084327"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-683"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-684"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084328"><a href="#local-6989586621679084328"><span class="hs-identifier">evH</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-685"></a><span>       </span><a name="local-6989586621679084329"><a href="#local-6989586621679084329"><span class="hs-identifier">evt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Browser.html#buildBrowserEvent"><span class="hs-identifier hs-var">buildBrowserEvent</span></a><span> </span><a href="#local-6989586621679084325"><span class="hs-identifier hs-var">bt</span></a><span> </span><a href="#local-6989586621679084326"><span class="hs-identifier hs-var">uri</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">bsRequestID</span><span> </span><a href="#local-6989586621679084327"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>       </span><a href="#local-6989586621679084328"><span class="hs-identifier hs-var">evH</span></a><span> </span><a href="#local-6989586621679084329"><span class="hs-identifier hs-var">evt</span></a><span> </span><span class="hs-comment">-- if it fails, we fail.</span><span>
</span><a name="line-687"></a><span>
</span><a name="line-688"></a><span class="hs-comment">-- | The default number of hops we are willing not to go beyond for </span><span>
</span><a name="line-689"></a><span class="hs-comment">-- request forwardings.</span><span>
</span><a name="line-690"></a><span class="hs-identifier">defaultMaxRetries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-691"></a><a name="defaultMaxRetries"><a href="Network.Browser.html#defaultMaxRetries"><span class="hs-identifier">defaultMaxRetries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-692"></a><span>
</span><a name="line-693"></a><span class="hs-comment">-- | The default number of error retries we are willing to perform.</span><span>
</span><a name="line-694"></a><span class="hs-identifier">defaultMaxErrorRetries</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-695"></a><a name="defaultMaxErrorRetries"><a href="Network.Browser.html#defaultMaxErrorRetries"><span class="hs-identifier">defaultMaxErrorRetries</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">4</span><span>
</span><a name="line-696"></a><span>
</span><a name="line-697"></a><span class="hs-comment">-- | The default maximum HTTP Authentication attempts we will make for</span><span>
</span><a name="line-698"></a><span class="hs-comment">-- a single request.</span><span>
</span><a name="line-699"></a><span class="hs-identifier">defaultMaxAuthAttempts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-700"></a><a name="defaultMaxAuthAttempts"><a href="Network.Browser.html#defaultMaxAuthAttempts"><span class="hs-identifier">defaultMaxAuthAttempts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span>
</span><a name="line-701"></a><span>
</span><a name="line-702"></a><span class="hs-comment">-- | The default setting for auto-proxy detection.</span><span>
</span><a name="line-703"></a><span class="hs-comment">-- You may change this within a session via 'setAutoProxyDetect'.</span><span>
</span><a name="line-704"></a><span class="hs-comment">-- To avoid initial backwards compatibility issues, leave this as @False@.</span><span>
</span><a name="line-705"></a><span class="hs-identifier">defaultAutoProxyDetect</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-706"></a><a name="defaultAutoProxyDetect"><a href="Network.Browser.html#defaultAutoProxyDetect"><span class="hs-identifier">defaultAutoProxyDetect</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span class="hs-comment">-- | @request httpRequest@ tries to submit the 'Request' @httpRequest@</span><span>
</span><a name="line-709"></a><span class="hs-comment">-- to some HTTP server (possibly going via a /proxy/, see 'setProxy'.)</span><span>
</span><a name="line-710"></a><span class="hs-comment">-- Upon successful delivery, the URL where the response was fetched from</span><span>
</span><a name="line-711"></a><span class="hs-comment">-- is returned along with the 'Response' itself.</span><span>
</span><a name="line-712"></a><span class="hs-identifier">request</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.TCP.html#HStream"><span class="hs-identifier hs-type">HStream</span></a><span> </span><a href="#local-6989586621679084142"><span class="hs-identifier hs-type">ty</span></a><span>
</span><a name="line-713"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.HTTP.Base.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><a href="#local-6989586621679084142"><span class="hs-identifier hs-type">ty</span></a><span>
</span><a name="line-714"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084142"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span class="hs-special">,</span><a href="Network.HTTP.Base.html#Response"><span class="hs-identifier hs-type">Response</span></a><span> </span><a href="#local-6989586621679084142"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><a name="request"><a href="Network.Browser.html#request"><span class="hs-identifier">request</span></a></a><span> </span><a name="local-6989586621679084330"><a href="#local-6989586621679084330"><span class="hs-identifier">req</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#nextRequest"><span class="hs-identifier hs-var">nextRequest</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-716"></a><span>  </span><a name="local-6989586621679084333"><a href="#local-6989586621679084333"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#request%27"><span class="hs-identifier hs-var">request'</span></a><span> </span><a href="#local-6989586621679084332"><span class="hs-identifier hs-var">nullVal</span></a><span> </span><a href="#local-6989586621679084331"><span class="hs-identifier hs-var">initialState</span></a><span> </span><a href="#local-6989586621679084330"><span class="hs-identifier hs-var">req</span></a><span>
</span><a name="line-717"></a><span>  </span><a href="Network.Browser.html#reportEvent"><span class="hs-identifier hs-var">reportEvent</span></a><span> </span><a href="Network.Browser.html#ResponseFinish"><span class="hs-identifier hs-var">ResponseFinish</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084330"><span class="hs-identifier hs-var">req</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-718"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084333"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-719"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679084334"><a href="#local-6989586621679084334"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084334"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-720"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679084335"><a href="#local-6989586621679084335"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-721"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084336"><a href="#local-6989586621679084336"><span class="hs-identifier">errStr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Network.Browser.request: Error raised &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084335"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-722"></a><span>     </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><a href="#local-6989586621679084336"><span class="hs-identifier hs-var">errStr</span></a><span>
</span><a name="line-723"></a><span>     </span><span class="hs-identifier hs-var">fail</span><span> </span><a href="#local-6989586621679084336"><span class="hs-identifier hs-var">errStr</span></a><span>
</span><a name="line-724"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-725"></a><span>  </span><a name="local-6989586621679084331"><a href="#local-6989586621679084331"><span class="hs-identifier">initialState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#nullRequestState"><span class="hs-identifier hs-var">nullRequestState</span></a><span>
</span><a name="line-726"></a><span>  </span><a name="local-6989586621679084332"><a href="#local-6989586621679084332"><span class="hs-identifier">nullVal</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">buf_empty</span><span> </span><a href="Network.BufferType.html#bufferOps"><span class="hs-identifier hs-var">bufferOps</span></a><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-comment">-- | Internal helper function, explicitly carrying along per-request </span><span>
</span><a name="line-729"></a><span class="hs-comment">-- counts.</span><span>
</span><a name="line-730"></a><span class="hs-identifier">request'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.TCP.html#HStream"><span class="hs-identifier hs-type">HStream</span></a><span> </span><a href="#local-6989586621679084141"><span class="hs-identifier hs-type">ty</span></a><span>
</span><a name="line-731"></a><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679084141"><span class="hs-identifier hs-type">ty</span></a><span>
</span><a name="line-732"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#RequestState"><span class="hs-identifier hs-type">RequestState</span></a><span>
</span><a name="line-733"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Base.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><a href="#local-6989586621679084141"><span class="hs-identifier hs-type">ty</span></a><span>
</span><a name="line-734"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084141"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Network.Stream.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">URI</span><span class="hs-special">,</span><a href="Network.HTTP.Base.html#Response"><span class="hs-identifier hs-type">Response</span></a><span> </span><a href="#local-6989586621679084141"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-735"></a><a name="request%27"><a href="Network.Browser.html#request%27"><span class="hs-identifier">request'</span></a></a><span> </span><a name="local-6989586621679084337"><a href="#local-6989586621679084337"><span class="hs-identifier">nullVal</span></a></a><span> </span><a name="local-6989586621679084338"><a href="#local-6989586621679084338"><span class="hs-identifier">rqState</span></a></a><span> </span><a name="local-6989586621679084339"><a href="#local-6989586621679084339"><span class="hs-identifier">rq</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-736"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084340"><a href="#local-6989586621679084340"><span class="hs-identifier">uri</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-737"></a><span>   </span><a href="Network.HTTP.Base.html#failHTTPS"><span class="hs-identifier hs-var">failHTTPS</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-738"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084341"><a href="#local-6989586621679084341"><span class="hs-identifier">uria</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Base.html#reqURIAuth"><span class="hs-identifier hs-var">reqURIAuth</span></a><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span> </span><span>
</span><a name="line-739"></a><span>     </span><span class="hs-comment">-- add cookies to request</span><span>
</span><a name="line-740"></a><span>   </span><a name="local-6989586621679084342"><a href="#local-6989586621679084342"><span class="hs-identifier">cookies</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getCookiesFor"><span class="hs-identifier hs-var">getCookiesFor</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#uriAuthToString"><span class="hs-identifier hs-var">uriAuthToString</span></a><span> </span><a href="#local-6989586621679084341"><span class="hs-identifier hs-var">uria</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriPath</span><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span>
</span><a name="line-741"></a><span class="hs-comment">{- Not for now:
   (case uriUserInfo uria of
     &quot;&quot; -&gt; id
     xs -&gt;
       case chopAtDelim ':' xs of
         (_,[])    -&gt; id
	 (usr,pwd) -&gt; withAuth
	                  AuthBasic{ auUserName = usr
                                   , auPassword = pwd
			           , auRealm    = &quot;/&quot;
			           , auSite     = uri
			           }) $ do
-}</span><span>
</span><a name="line-754"></a><span>   </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084342"><span class="hs-identifier hs-var">cookies</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-755"></a><span>        </span><span class="hs-special">(</span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Adding cookies to request.  Cookie names: &quot;</span><span>  </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unwords</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ckName</span><span> </span><a href="#local-6989586621679084342"><span class="hs-identifier hs-var">cookies</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>    </span><span class="hs-comment">-- add credentials to request</span><span>
</span><a name="line-757"></a><span>   </span><a name="local-6989586621679084345"><a href="#local-6989586621679084345"><span class="hs-identifier">rq'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span>
</span><a name="line-758"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reqStopOnDeny</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-759"></a><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span> </span><span>
</span><a name="line-760"></a><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-761"></a><span>       </span><a name="local-6989586621679084343"><a href="#local-6989586621679084343"><span class="hs-identifier">auth</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#anticipateChallenge"><span class="hs-identifier hs-var">anticipateChallenge</span></a><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-762"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084343"><span class="hs-identifier hs-var">auth</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-763"></a><span>         </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-764"></a><span>         </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084344"><a href="#local-6989586621679084344"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#insertHeader"><span class="hs-identifier hs-var">insertHeader</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrAuthorization"><span class="hs-identifier hs-var">HdrAuthorization</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#withAuthority"><span class="hs-identifier hs-var">withAuthority</span></a><span> </span><a href="#local-6989586621679084344"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084346"><a href="#local-6989586621679084346"><span class="hs-identifier">rq''</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084342"><span class="hs-identifier hs-var">cookies</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Network.HTTP.Headers.html#insertHeaders"><span class="hs-identifier hs-var">insertHeaders</span></a><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Cookie.html#cookiesToHeader"><span class="hs-identifier hs-var">cookiesToHeader</span></a><span> </span><a href="#local-6989586621679084342"><span class="hs-identifier hs-var">cookies</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621679084345"><span class="hs-identifier hs-var">rq'</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679084345"><span class="hs-identifier hs-var">rq'</span></a><span>
</span><a name="line-766"></a><span>   </span><a name="local-6989586621679084347"><a href="#local-6989586621679084347"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getProxy"><span class="hs-identifier hs-var">getProxy</span></a><span>
</span><a name="line-767"></a><span>   </span><a name="local-6989586621679084348"><a href="#local-6989586621679084348"><span class="hs-identifier">def_ua</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsUserAgent</span><span>
</span><a name="line-768"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084349"><a href="#local-6989586621679084349"><span class="hs-identifier">defaultOpts</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-769"></a><span>         </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084347"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-770"></a><span>           </span><a href="Network.HTTP.Proxy.html#NoProxy"><span class="hs-identifier hs-var">NoProxy</span></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Base.html#defaultNormalizeRequestOptions"><span class="hs-identifier hs-var">defaultNormalizeRequestOptions</span></a><span class="hs-special">{</span><span class="hs-identifier">normUserAgent</span><span class="hs-glyph">=</span><a href="#local-6989586621679084348"><span class="hs-identifier hs-var">def_ua</span></a><span class="hs-special">}</span><span>
</span><a name="line-771"></a><span>           </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679084350"><a href="#local-6989586621679084350"><span class="hs-identifier">ath</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-772"></a><span>              </span><a href="Network.HTTP.Base.html#defaultNormalizeRequestOptions"><span class="hs-identifier hs-var">defaultNormalizeRequestOptions</span></a><span>
</span><a name="line-773"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">normForProxy</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-774"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">normUserAgent</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084348"><span class="hs-identifier hs-var">def_ua</span></a><span>
</span><a name="line-775"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">normCustoms</span><span>   </span><span class="hs-glyph">=</span><span>
</span><a name="line-776"></a><span>                    </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-777"></a><span>                          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679084351"><a href="#local-6989586621679084351"><span class="hs-identifier">authS</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-glyph">\</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679084352"><a href="#local-6989586621679084352"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Headers.html#insertHeader"><span class="hs-identifier hs-var">insertHeader</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrProxyAuthorization"><span class="hs-identifier hs-var">HdrProxyAuthorization</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#withAuthority"><span class="hs-identifier hs-var">withAuthority</span></a><span> </span><a href="#local-6989586621679084351"><span class="hs-identifier hs-var">authS</span></a><span> </span><a href="#local-6989586621679084352"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084352"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-778"></a><span>                          </span><a href="#local-6989586621679084350"><span class="hs-identifier hs-var">ath</span></a><span>
</span><a name="line-779"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-780"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084353"><a href="#local-6989586621679084353"><span class="hs-identifier">final_req</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Base.html#normalizeRequest"><span class="hs-identifier hs-var">normalizeRequest</span></a><span> </span><a href="#local-6989586621679084349"><span class="hs-identifier hs-var">defaultOpts</span></a><span> </span><a href="#local-6989586621679084346"><span class="hs-identifier hs-var">rq''</span></a><span>
</span><a name="line-781"></a><span>   </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Sending:\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084353"><span class="hs-identifier hs-var">final_req</span></a><span class="hs-special">)</span><span>
</span><a name="line-782"></a><span>   </span><a name="local-6989586621679084361"><a href="#local-6989586621679084361"><span class="hs-identifier">e_rsp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span>
</span><a name="line-783"></a><span>     </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084347"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-784"></a><span>       </span><a href="Network.HTTP.Proxy.html#NoProxy"><span class="hs-identifier hs-var">NoProxy</span></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#dorequest"><span class="hs-identifier hs-var">dorequest</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#reqURIAuth"><span class="hs-identifier hs-var">reqURIAuth</span></a><span> </span><a href="#local-6989586621679084346"><span class="hs-identifier hs-var">rq''</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084353"><span class="hs-identifier hs-var">final_req</span></a><span>
</span><a name="line-785"></a><span>       </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span> </span><a name="local-6989586621679084354"><a href="#local-6989586621679084354"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621679084355"><a href="#local-6989586621679084355"><span class="hs-identifier">_ath</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-786"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084356"><a href="#local-6989586621679084356"><span class="hs-identifier">notURI</span></a></a><span> </span><span>
</span><a name="line-787"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084358"><span class="hs-identifier hs-var">pt</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084357"><span class="hs-identifier hs-var">hst</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-788"></a><span>                 </span><span class="hs-identifier hs-var">URIAuth</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uriUserInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-789"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uriRegName</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084354"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-790"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uriPort</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-791"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-792"></a><span>               </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-793"></a><span>                 </span><span class="hs-identifier hs-var">URIAuth</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uriUserInfo</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-794"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uriRegName</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084357"><span class="hs-identifier hs-var">hst</span></a><span>
</span><a name="line-795"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uriPort</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084358"><span class="hs-identifier hs-var">pt</span></a><span>
</span><a name="line-796"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-797"></a><span>                  </span><span class="hs-comment">-- If the ':' is dropped from port below, dorequest will assume port 80. Leave it!</span><span>
</span><a name="line-798"></a><span>                 </span><span class="hs-keyword">where</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679084357"><a href="#local-6989586621679084357"><span class="hs-identifier">hst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679084358"><a href="#local-6989586621679084358"><span class="hs-identifier">pt</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">span</span><span> </span><span class="hs-special">(</span><span class="hs-char">':'</span><span class="hs-operator hs-var">/=</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084354"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-799"></a><span>           </span><span class="hs-comment">-- Proxy can take multiple forms - look for http://host:port first,</span><span>
</span><a name="line-800"></a><span>           </span><span class="hs-comment">-- then host:port. Fall back to just the string given (probably a host name).</span><span>
</span><a name="line-801"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084359"><a href="#local-6989586621679084359"><span class="hs-identifier">proxyURIAuth</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-802"></a><span>                </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679084356"><span class="hs-identifier hs-var">notURI</span></a><span>
</span><a name="line-803"></a><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084360"><a href="#local-6989586621679084360"><span class="hs-identifier">parsed</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621679084356"><span class="hs-identifier hs-var">notURI</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriAuthority</span><span> </span><a href="#local-6989586621679084360"><span class="hs-identifier hs-var">parsed</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span>                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">parseURI</span><span> </span><a href="#local-6989586621679084354"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>          </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;proxy uri host: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">uriRegName</span><span> </span><a href="#local-6989586621679084359"><span class="hs-identifier hs-var">proxyURIAuth</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;, port: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">uriPort</span><span> </span><a href="#local-6989586621679084359"><span class="hs-identifier hs-var">proxyURIAuth</span></a><span>
</span><a name="line-807"></a><span>          </span><a href="Network.Browser.html#dorequest"><span class="hs-identifier hs-var">dorequest</span></a><span> </span><a href="#local-6989586621679084359"><span class="hs-identifier hs-var">proxyURIAuth</span></a><span> </span><a href="#local-6989586621679084353"><span class="hs-identifier hs-var">final_req</span></a><span>
</span><a name="line-808"></a><span>   </span><a name="local-6989586621679084362"><a href="#local-6989586621679084362"><span class="hs-identifier">mbMx</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getMaxErrorRetries"><span class="hs-identifier hs-var">getMaxErrorRetries</span></a><span>
</span><a name="line-809"></a><span>   </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084361"><span class="hs-identifier hs-var">e_rsp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-810"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679084363"><a href="#local-6989586621679084363"><span class="hs-identifier">v</span></a></a><span> </span><span>
</span><a name="line-811"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reqRetries</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Network.Browser.html#defaultMaxErrorRetries"><span class="hs-identifier hs-var">defaultMaxErrorRetries</span></a><span> </span><a href="#local-6989586621679084362"><span class="hs-identifier hs-var">mbMx</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span>
</span><a name="line-812"></a><span>       </span><span class="hs-special">(</span><a href="#local-6989586621679084363"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.Stream.html#ErrorReset"><span class="hs-identifier hs-var">ErrorReset</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679084363"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Network.Stream.html#ErrorClosed"><span class="hs-identifier hs-var">ErrorClosed</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-813"></a><span>       </span><span class="hs-comment">--empty connnection pool in case connection has become invalid</span><span>
</span><a name="line-814"></a><span>       </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084364"><a href="#local-6989586621679084364"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084364"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span>
</span><a name="line-815"></a><span>       </span><a href="Network.Browser.html#request%27"><span class="hs-identifier hs-var">request'</span></a><span> </span><a href="#local-6989586621679084337"><span class="hs-identifier hs-var">nullVal</span></a><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">{</span><span class="hs-identifier">reqRetries</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">succ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reqRetries</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">)</span><span class="hs-special">}</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-816"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><a name="line-817"></a><span>       </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621679084363"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-818"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679084365"><a href="#local-6989586621679084365"><span class="hs-identifier">rsp</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-819"></a><span>     </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Received:\n&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span>
</span><a name="line-820"></a><span>      </span><span class="hs-comment">-- add new cookies to browser state</span><span>
</span><a name="line-821"></a><span>     </span><a href="Network.Browser.html#handleCookies"><span class="hs-identifier hs-var">handleCookies</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#uriAuthToString"><span class="hs-identifier hs-var">uriAuthToString</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.HTTP.Base.html#reqURIAuth"><span class="hs-identifier hs-var">reqURIAuth</span></a><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-822"></a><span>                       </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#retrieveHeaders"><span class="hs-identifier hs-var">retrieveHeaders</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrSetCookie"><span class="hs-identifier hs-var">HdrSetCookie</span></a><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span>     </span><span class="hs-comment">-- Deal with &quot;Connection: close&quot; in response.</span><span>
</span><a name="line-824"></a><span>     </span><a href="Network.Browser.html#handleConnectionClose"><span class="hs-identifier hs-var">handleConnectionClose</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#reqURIAuth"><span class="hs-identifier hs-var">reqURIAuth</span></a><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#retrieveHeaders"><span class="hs-identifier hs-var">retrieveHeaders</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrConnection"><span class="hs-identifier hs-var">HdrConnection</span></a><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span>
</span><a name="line-825"></a><span>     </span><a name="local-6989586621679084366"><a href="#local-6989586621679084366"><span class="hs-identifier">mbMxAuths</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getMaxAuthAttempts"><span class="hs-identifier hs-var">getMaxAuthAttempts</span></a><span>
</span><a name="line-826"></a><span>     </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">rspCode</span><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-827"></a><span>      </span><span class="hs-special">(</span><span class="hs-number">4</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Credentials not sent or refused.</span><span>
</span><a name="line-828"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">reqDenies</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Network.Browser.html#defaultMaxAuthAttempts"><span class="hs-identifier hs-var">defaultMaxAuthAttempts</span></a><span> </span><a href="#local-6989586621679084366"><span class="hs-identifier hs-var">mbMxAuths</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-829"></a><span>          </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;401 - credentials again refused; exceeded retry count (2)&quot;</span><span>
</span><a name="line-830"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-831"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-832"></a><span>          </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;401 - credentials not supplied or refused; retrying..&quot;</span><span>
</span><a name="line-833"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084367"><a href="#local-6989586621679084367"><span class="hs-identifier">hdrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Headers.html#retrieveHeaders"><span class="hs-identifier hs-var">retrieveHeaders</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrWWWAuthenticate"><span class="hs-identifier hs-var">HdrWWWAuthenticate</span></a><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span>
</span><a name="line-834"></a><span>          </span><a name="local-6989586621679084368"><a href="#local-6989586621679084368"><span class="hs-identifier">flg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getAllowBasicAuth"><span class="hs-identifier hs-var">getAllowBasicAuth</span></a><span>
</span><a name="line-835"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="Network.Browser.html#pickChallenge"><span class="hs-identifier hs-var">pickChallenge</span></a><span> </span><a href="#local-6989586621679084368"><span class="hs-identifier hs-var">flg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#headerToChallenge"><span class="hs-identifier hs-var">headerToChallenge</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084367"><span class="hs-identifier hs-var">hdrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-836"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-837"></a><span>              </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;no challenge&quot;</span><span>
</span><a name="line-838"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">{- do nothing -}</span><span>
</span><a name="line-839"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084369"><a href="#local-6989586621679084369"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-840"></a><span>              </span><a name="local-6989586621679084370"><a href="#local-6989586621679084370"><span class="hs-identifier">au</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#challengeToAuthority"><span class="hs-identifier hs-var">challengeToAuthority</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span> </span><a href="#local-6989586621679084369"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-841"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084370"><span class="hs-identifier hs-var">au</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-842"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-843"></a><span>                  </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;no auth&quot;</span><span>
</span><a name="line-844"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">{- do nothing -}</span><span>
</span><a name="line-845"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084371"><a href="#local-6989586621679084371"><span class="hs-identifier">au'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-846"></a><span>                  </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;Retrying request with new credentials&quot;</span><span>
</span><a name="line-847"></a><span>                  </span><a href="Network.Browser.html#request%27"><span class="hs-identifier hs-var">request'</span></a><span> </span><a href="#local-6989586621679084337"><span class="hs-identifier hs-var">nullVal</span></a><span>
</span><a name="line-848"></a><span>                           </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">reqDenies</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span class="hs-special">(</span><span class="hs-identifier">reqDenies</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>                                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqStopOnDeny</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-850"></a><span>                                  </span><span class="hs-special">}</span><span>
</span><a name="line-851"></a><span>                           </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#insertHeader"><span class="hs-identifier hs-var">insertHeader</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrAuthorization"><span class="hs-identifier hs-var">HdrAuthorization</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#withAuthority"><span class="hs-identifier hs-var">withAuthority</span></a><span> </span><a href="#local-6989586621679084371"><span class="hs-identifier hs-var">au'</span></a><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span class="hs-special">)</span><span>
</span><a name="line-852"></a><span>
</span><a name="line-853"></a><span>      </span><span class="hs-special">(</span><span class="hs-number">4</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">7</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Proxy Authentication required</span><span>
</span><a name="line-854"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">reqDenies</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Network.Browser.html#defaultMaxAuthAttempts"><span class="hs-identifier hs-var">defaultMaxAuthAttempts</span></a><span> </span><a href="#local-6989586621679084366"><span class="hs-identifier hs-var">mbMxAuths</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-855"></a><span>          </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;407 - proxy authentication required; max deny count exceeeded (2)&quot;</span><span>
</span><a name="line-856"></a><span>          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-857"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-858"></a><span>          </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;407 - proxy authentication required&quot;</span><span>
</span><a name="line-859"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084372"><a href="#local-6989586621679084372"><span class="hs-identifier">hdrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Headers.html#retrieveHeaders"><span class="hs-identifier hs-var">retrieveHeaders</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrProxyAuthenticate"><span class="hs-identifier hs-var">HdrProxyAuthenticate</span></a><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span>
</span><a name="line-860"></a><span>          </span><a name="local-6989586621679084373"><a href="#local-6989586621679084373"><span class="hs-identifier">flg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getAllowBasicAuth"><span class="hs-identifier hs-var">getAllowBasicAuth</span></a><span>
</span><a name="line-861"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="Network.Browser.html#pickChallenge"><span class="hs-identifier hs-var">pickChallenge</span></a><span> </span><a href="#local-6989586621679084373"><span class="hs-identifier hs-var">flg</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Auth.html#headerToChallenge"><span class="hs-identifier hs-var">headerToChallenge</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084372"><span class="hs-identifier hs-var">hdrs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-862"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">{- do nothing -}</span><span>
</span><a name="line-863"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084374"><a href="#local-6989586621679084374"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-864"></a><span>              </span><a name="local-6989586621679084375"><a href="#local-6989586621679084375"><span class="hs-identifier">au</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#challengeToAuthority"><span class="hs-identifier hs-var">challengeToAuthority</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span> </span><a href="#local-6989586621679084374"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-865"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084375"><span class="hs-identifier hs-var">au</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-866"></a><span>               </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">{- do nothing -}</span><span>
</span><a name="line-867"></a><span>               </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084376"><a href="#local-6989586621679084376"><span class="hs-identifier">au'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-868"></a><span>                 </span><a name="local-6989586621679084377"><a href="#local-6989586621679084377"><span class="hs-identifier">pxy</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsProxy</span><span>
</span><a name="line-869"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084377"><span class="hs-identifier hs-var">pxy</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-870"></a><span>                   </span><a href="Network.HTTP.Proxy.html#NoProxy"><span class="hs-identifier hs-var">NoProxy</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-871"></a><span>                     </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-string">&quot;Proxy authentication required without proxy!&quot;</span><span>
</span><a name="line-872"></a><span>                     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-873"></a><span>                   </span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span> </span><a name="local-6989586621679084378"><a href="#local-6989586621679084378"><span class="hs-identifier">px</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-874"></a><span>                     </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-string">&quot;Retrying with proxy authentication&quot;</span><span>
</span><a name="line-875"></a><span>                     </span><a href="Network.Browser.html#setProxy"><span class="hs-identifier hs-var">setProxy</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span> </span><a href="#local-6989586621679084378"><span class="hs-identifier hs-var">px</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679084376"><span class="hs-identifier hs-var">au'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-876"></a><span>                     </span><a href="Network.Browser.html#request%27"><span class="hs-identifier hs-var">request'</span></a><span> </span><a href="#local-6989586621679084337"><span class="hs-identifier hs-var">nullVal</span></a><span>
</span><a name="line-877"></a><span>                              </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">reqDenies</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span class="hs-special">(</span><span class="hs-identifier">reqDenies</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">)</span><span>
</span><a name="line-878"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqStopOnDeny</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-879"></a><span>                                     </span><span class="hs-special">}</span><span>
</span><a name="line-880"></a><span>                              </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-881"></a><span>
</span><a name="line-882"></a><span>      </span><span class="hs-special">(</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><a name="local-6989586621679084379"><a href="#local-6989586621679084379"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679084379"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-number">1</span><span class="hs-special">,</span><span class="hs-number">7</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-keyword">do</span><span>
</span><a name="line-883"></a><span>        </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;30&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084379"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">++</span><span>  </span><span class="hs-string">&quot; - redirect&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-884"></a><span>        </span><a name="local-6989586621679084380"><a href="#local-6989586621679084380"><span class="hs-identifier">allow_redirs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#allowRedirect"><span class="hs-identifier hs-var">allowRedirect</span></a><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span>
</span><a name="line-885"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084380"><span class="hs-identifier hs-var">allow_redirs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-886"></a><span>          </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-887"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-888"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="Network.HTTP.Headers.html#retrieveHeaders"><span class="hs-identifier hs-var">retrieveHeaders</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrLocation"><span class="hs-identifier hs-var">HdrLocation</span></a><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-889"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-890"></a><span>              </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-string">&quot;No Location: header in redirect response&quot;</span><span>
</span><a name="line-891"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-892"></a><span>            </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679084381"><a href="#local-6989586621679084381"><span class="hs-identifier">u</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><a name="line-893"></a><span>              </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">parseURIReference</span><span> </span><a href="#local-6989586621679084381"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-894"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-895"></a><span>                  </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Parse of Location: header in a redirect response failed: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679084381"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-896"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-897"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084382"><a href="#local-6989586621679084382"><span class="hs-identifier">newURI</span></a></a><span>
</span><a name="line-898"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">{-uriScheme newURI_abs /= uriScheme uri &amp;&amp; -}</span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#supportedScheme"><span class="hs-identifier hs-var">supportedScheme</span></a><span> </span><a href="#local-6989586621679084383"><span class="hs-identifier hs-var">newURI_abs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-899"></a><span>                    </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Unable to handle redirect, unsupported scheme: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084383"><span class="hs-identifier hs-var">newURI_abs</span></a><span class="hs-special">)</span><span>
</span><a name="line-900"></a><span>                    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-901"></a><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-902"></a><span>                    </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Redirecting to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084383"><span class="hs-identifier hs-var">newURI_abs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; ...&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-903"></a><span>                    </span><span>
</span><a name="line-904"></a><span>                    </span><span class="hs-comment">-- Redirect using GET request method, depending on</span><span>
</span><a name="line-905"></a><span>                    </span><span class="hs-comment">-- response code.</span><span>
</span><a name="line-906"></a><span>                    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084384"><a href="#local-6989586621679084384"><span class="hs-identifier">toGet</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084379"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-number">2</span><span class="hs-special">,</span><span class="hs-number">3</span><span class="hs-special">]</span><span>
</span><a name="line-907"></a><span>                        </span><a name="local-6989586621679084385"><a href="#local-6989586621679084385"><span class="hs-identifier">method</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679084384"><span class="hs-identifier hs-var">toGet</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Network.HTTP.Base.html#GET"><span class="hs-identifier hs-var">GET</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">rqMethod</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-908"></a><span>                        </span><a name="local-6989586621679084386"><a href="#local-6989586621679084386"><span class="hs-identifier">rq1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rqMethod</span><span class="hs-glyph">=</span><a href="#local-6989586621679084385"><span class="hs-identifier hs-var">method</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqURI</span><span class="hs-glyph">=</span><a href="#local-6989586621679084383"><span class="hs-identifier hs-var">newURI_abs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-909"></a><span>                        </span><a name="local-6989586621679084387"><a href="#local-6989586621679084387"><span class="hs-identifier">rq2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679084384"><span class="hs-identifier hs-var">toGet</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#replaceHeader"><span class="hs-identifier hs-var">replaceHeader</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrContentLength"><span class="hs-identifier hs-var">HdrContentLength</span></a><span> </span><span class="hs-string">&quot;0&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084386"><span class="hs-identifier hs-var">rq1</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">rqBody</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084337"><span class="hs-identifier hs-var">nullVal</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679084386"><span class="hs-identifier hs-var">rq1</span></a><span>
</span><a name="line-910"></a><span>                    </span><span>
</span><a name="line-911"></a><span>                    </span><a href="Network.Browser.html#request%27"><span class="hs-identifier hs-var">request'</span></a><span> </span><a href="#local-6989586621679084337"><span class="hs-identifier hs-var">nullVal</span></a><span>
</span><a name="line-912"></a><span>                            </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">reqDenies</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-913"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqRedirects</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span class="hs-special">(</span><span class="hs-identifier">reqRedirects</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">)</span><span>
</span><a name="line-914"></a><span>                                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqStopOnDeny</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-915"></a><span>                                   </span><span class="hs-special">}</span><span>
</span><a name="line-916"></a><span>                             </span><a href="#local-6989586621679084387"><span class="hs-identifier hs-var">rq2</span></a><span>
</span><a name="line-917"></a><span>                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-918"></a><span>                   </span><a name="local-6989586621679084383"><a href="#local-6989586621679084383"><span class="hs-identifier">newURI_abs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.Browser.html#uriDefaultTo"><span class="hs-identifier hs-var">uriDefaultTo</span></a><span> </span><a href="#local-6989586621679084382"><span class="hs-identifier hs-var">newURI</span></a><span> </span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-919"></a><span>
</span><a name="line-920"></a><span>      </span><span class="hs-special">(</span><span class="hs-number">3</span><span class="hs-special">,</span><span class="hs-number">0</span><span class="hs-special">,</span><span class="hs-number">5</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-921"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Network.HTTP.Headers.html#retrieveHeaders"><span class="hs-identifier hs-var">retrieveHeaders</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrLocation"><span class="hs-identifier hs-var">HdrLocation</span></a><span> </span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-922"></a><span>         </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-923"></a><span>           </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-string">&quot;No Location header in proxy redirect response.&quot;</span><span>
</span><a name="line-924"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>         </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679084388"><a href="#local-6989586621679084388"><span class="hs-identifier">u</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><a name="line-926"></a><span>           </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">parseURIReference</span><span> </span><a href="#local-6989586621679084388"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-927"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-928"></a><span>             </span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Parse of Location header in a proxy redirect response failed: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679084388"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span>
</span><a name="line-929"></a><span>             </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679084389"><a href="#local-6989586621679084389"><span class="hs-identifier">newuri</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-931"></a><span>             </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Retrying with proxy &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084389"><span class="hs-identifier hs-var">newuri</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;...&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-932"></a><span>             </span><a href="Network.Browser.html#setProxy"><span class="hs-identifier hs-var">setProxy</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#uriToAuthorityString"><span class="hs-identifier hs-var">uriToAuthorityString</span></a><span> </span><a href="#local-6989586621679084389"><span class="hs-identifier hs-var">newuri</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>             </span><a href="Network.Browser.html#request%27"><span class="hs-identifier hs-var">request'</span></a><span> </span><a href="#local-6989586621679084337"><span class="hs-identifier hs-var">nullVal</span></a><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">reqDenies</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-934"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqRedirects</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-935"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqRetries</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">succ</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reqRetries</span><span> </span><a href="#local-6989586621679084338"><span class="hs-identifier hs-var">rqState</span></a><span class="hs-special">)</span><span>
</span><a name="line-936"></a><span>                                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">reqStopOnDeny</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-937"></a><span>                                     </span><span class="hs-special">}</span><span>
</span><a name="line-938"></a><span>                                     </span><a href="#local-6989586621679084339"><span class="hs-identifier hs-var">rq</span></a><span>
</span><a name="line-939"></a><span>      </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084340"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">,</span><a href="#local-6989586621679084365"><span class="hs-identifier hs-var">rsp</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>
</span><a name="line-941"></a><span class="hs-comment">-- | The internal request handling state machine.</span><span>
</span><a name="line-942"></a><span class="hs-identifier">dorequest</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HStream"><span class="hs-identifier hs-type">HStream</span></a><span> </span><a href="#local-6989586621679084140"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-943"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">URIAuth</span><span>
</span><a name="line-944"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Base.html#Request"><span class="hs-identifier hs-type">Request</span></a><span> </span><a href="#local-6989586621679084140"><span class="hs-identifier hs-type">ty</span></a><span>
</span><a name="line-945"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084140"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-946"></a><span>                           </span><span class="hs-special">(</span><a href="Network.Stream.html#Result"><span class="hs-identifier hs-type">Result</span></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#Response"><span class="hs-identifier hs-type">Response</span></a><span> </span><a href="#local-6989586621679084140"><span class="hs-identifier hs-type">ty</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-947"></a><a name="dorequest"><a href="Network.Browser.html#dorequest"><span class="hs-identifier">dorequest</span></a></a><span> </span><a name="local-6989586621679084390"><a href="#local-6989586621679084390"><span class="hs-identifier">hst</span></a></a><span> </span><a name="local-6989586621679084391"><a href="#local-6989586621679084391"><span class="hs-identifier">rqst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-948"></a><span>  </span><a name="local-6989586621679084402"><a href="#local-6989586621679084402"><span class="hs-identifier">pool</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span>
</span><a name="line-949"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084403"><a href="#local-6989586621679084403"><span class="hs-identifier">uPort</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Base.html#uriAuthPort"><span class="hs-identifier hs-var">uriAuthPort</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-comment">{-ToDo: feed in complete URL-}</span><span> </span><a href="#local-6989586621679084390"><span class="hs-identifier hs-var">hst</span></a><span>
</span><a name="line-950"></a><span>  </span><a name="local-6989586621679084405"><a href="#local-6989586621679084405"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084404"><a href="#local-6989586621679084404"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084404"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">`</span><a href="Network.TCP.html#isTCPConnectedTo"><span class="hs-identifier hs-var">isTCPConnectedTo</span></a><span class="hs-special">`</span><span> </span><a href="Network.TCP.html#EndPoint"><span class="hs-identifier hs-var">EndPoint</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriRegName</span><span> </span><a href="#local-6989586621679084390"><span class="hs-identifier hs-var">hst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084403"><span class="hs-identifier hs-var">uPort</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084402"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-951"></a><span>  </span><a name="local-6989586621679084408"><a href="#local-6989586621679084408"><span class="hs-identifier">rsp</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span>
</span><a name="line-952"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084405"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-953"></a><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-954"></a><span>        </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Creating new connection to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="Network.HTTP.Base.html#uriAuthToString"><span class="hs-identifier hs-var">uriAuthToString</span></a><span> </span><a href="#local-6989586621679084390"><span class="hs-identifier hs-var">hst</span></a><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>        </span><a href="Network.Browser.html#reportEvent"><span class="hs-identifier hs-var">reportEvent</span></a><span> </span><a href="Network.Browser.html#OpenConnection"><span class="hs-identifier hs-var">OpenConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084391"><span class="hs-identifier hs-var">rqst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-956"></a><span>        </span><a name="local-6989586621679084406"><a href="#local-6989586621679084406"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TCP.html#openStream"><span class="hs-identifier hs-var">openStream</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriRegName</span><span> </span><a href="#local-6989586621679084390"><span class="hs-identifier hs-var">hst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084403"><span class="hs-identifier hs-var">uPort</span></a><span>
</span><a name="line-957"></a><span>        </span><a href="Network.Browser.html#updateConnectionPool"><span class="hs-identifier hs-var">updateConnectionPool</span></a><span> </span><a href="#local-6989586621679084406"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-958"></a><span>        </span><a href="#local-6989586621679084392"><span class="hs-identifier hs-var">dorequest2</span></a><span> </span><a href="#local-6989586621679084406"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679084391"><span class="hs-identifier hs-var">rqst</span></a><span>
</span><a name="line-959"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621679084407"><a href="#local-6989586621679084407"><span class="hs-identifier">c</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-960"></a><span>        </span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Recovering connection to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="Network.HTTP.Base.html#uriAuthToString"><span class="hs-identifier hs-var">uriAuthToString</span></a><span> </span><a href="#local-6989586621679084390"><span class="hs-identifier hs-var">hst</span></a><span class="hs-special">)</span><span>
</span><a name="line-961"></a><span>        </span><a href="Network.Browser.html#reportEvent"><span class="hs-identifier hs-var">reportEvent</span></a><span> </span><a href="Network.Browser.html#ReuseConnection"><span class="hs-identifier hs-var">ReuseConnection</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084391"><span class="hs-identifier hs-var">rqst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-962"></a><span>        </span><a href="#local-6989586621679084392"><span class="hs-identifier hs-var">dorequest2</span></a><span> </span><a href="#local-6989586621679084407"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679084391"><span class="hs-identifier hs-var">rqst</span></a><span>
</span><a name="line-963"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084408"><span class="hs-identifier hs-var">rsp</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-964"></a><span>     </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#Response"><span class="hs-identifier hs-var">Response</span></a><span> </span><a name="local-6989586621679084409"><a href="#local-6989586621679084409"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679084410"><a href="#local-6989586621679084410"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621679084411"><a href="#local-6989586621679084411"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><a name="line-965"></a><span>         </span><a href="Network.Browser.html#reportEvent"><span class="hs-identifier hs-var">reportEvent</span></a><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#ResponseEnd"><span class="hs-identifier hs-var">ResponseEnd</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084409"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621679084410"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621679084411"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084391"><span class="hs-identifier hs-var">rqst</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">;</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-966"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679084408"><span class="hs-identifier hs-var">rsp</span></a><span>
</span><a name="line-967"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-968"></a><span>  </span><a name="local-6989586621679084392"><a href="#local-6989586621679084392"><span class="hs-identifier">dorequest2</span></a></a><span> </span><a name="local-6989586621679084393"><a href="#local-6989586621679084393"><span class="hs-identifier">c</span></a></a><span> </span><a name="local-6989586621679084394"><a href="#local-6989586621679084394"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-969"></a><span>    </span><a name="local-6989586621679084395"><a href="#local-6989586621679084395"><span class="hs-identifier">dbg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsDebug</span><span>
</span><a name="line-970"></a><span>    </span><a name="local-6989586621679084396"><a href="#local-6989586621679084396"><span class="hs-identifier">st</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">get</span><span>
</span><a name="line-971"></a><span>    </span><span class="hs-keyword">let</span><span> </span><span>
</span><a name="line-972"></a><span>     </span><a name="local-6989586621679084397"><a href="#local-6989586621679084397"><span class="hs-identifier">onSendComplete</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-973"></a><span>       </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-974"></a><span>             </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084398"><a href="#local-6989586621679084398"><span class="hs-identifier">evh</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-975"></a><span>                </span><a name="local-6989586621679084399"><a href="#local-6989586621679084399"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#buildBrowserEvent"><span class="hs-identifier hs-var">buildBrowserEvent</span></a><span> </span><a href="Network.Browser.html#RequestSent"><span class="hs-identifier hs-var">RequestSent</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rqURI</span><span> </span><a href="#local-6989586621679084394"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">bsRequestID</span><span> </span><a href="#local-6989586621679084396"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-976"></a><span>                </span><a href="Network.Browser.html#runBA"><span class="hs-identifier hs-var">runBA</span></a><span> </span><a href="#local-6989586621679084396"><span class="hs-identifier hs-var">st</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084398"><span class="hs-identifier hs-var">evh</span></a><span> </span><a href="#local-6989586621679084399"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-977"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-978"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier">bsEvent</span><span> </span><a href="#local-6989586621679084396"><span class="hs-identifier hs-var">st</span></a><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span>    </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span>
</span><a name="line-980"></a><span>      </span><span class="hs-identifier hs-var">maybe</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.HandleStream.html#sendHTTP_notify"><span class="hs-identifier hs-var">sendHTTP_notify</span></a><span> </span><a href="#local-6989586621679084393"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="#local-6989586621679084394"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679084397"><span class="hs-identifier hs-var">onSendComplete</span></a><span class="hs-special">)</span><span>
</span><a name="line-981"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621679084400"><a href="#local-6989586621679084400"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-982"></a><span>               </span><a name="local-6989586621679084401"><a href="#local-6989586621679084401"><span class="hs-identifier">c'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.StreamDebugger.html#debugByteStream"><span class="hs-identifier hs-var">debugByteStream</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084400"><span class="hs-identifier hs-var">f</span></a><span class="hs-operator hs-var">++</span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><span> </span><a href="Network.HTTP.Base.html#uriAuthToString"><span class="hs-identifier hs-var">uriAuthToString</span></a><span> </span><a href="#local-6989586621679084390"><span class="hs-identifier hs-var">hst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084393"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-983"></a><span>               </span><a href="Network.HTTP.HandleStream.html#sendHTTP_notify"><span class="hs-identifier hs-var">sendHTTP_notify</span></a><span> </span><a href="#local-6989586621679084401"><span class="hs-identifier hs-var">c'</span></a><span> </span><a href="#local-6989586621679084394"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679084397"><span class="hs-identifier hs-var">onSendComplete</span></a><span class="hs-special">)</span><span>
</span><a name="line-984"></a><span>            </span><a href="#local-6989586621679084395"><span class="hs-identifier hs-var">dbg</span></a><span>
</span><a name="line-985"></a><span>
</span><a name="line-986"></a><span class="hs-identifier">updateConnectionPool</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.TCP.html#HStream"><span class="hs-identifier hs-type">HStream</span></a><span> </span><a href="#local-6989586621679084139"><span class="hs-identifier hs-type">hTy</span></a><span>
</span><a name="line-987"></a><span>                     </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084139"><span class="hs-identifier hs-type">hTy</span></a><span>
</span><a name="line-988"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084139"><span class="hs-identifier hs-type">hTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-989"></a><a name="updateConnectionPool"><a href="Network.Browser.html#updateConnectionPool"><span class="hs-identifier">updateConnectionPool</span></a></a><span> </span><a name="local-6989586621679084412"><a href="#local-6989586621679084412"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-990"></a><span>   </span><a name="local-6989586621679084413"><a href="#local-6989586621679084413"><span class="hs-identifier">pool</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span>
</span><a name="line-991"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084414"><a href="#local-6989586621679084414"><span class="hs-identifier">len_pool</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679084413"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-992"></a><span>   </span><a name="local-6989586621679084424"><a href="#local-6989586621679084424"><span class="hs-identifier">maxPoolSize</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Network.Browser.html#defaultMaxPoolSize"><span class="hs-identifier hs-var">defaultMaxPoolSize</span></a><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsMaxPoolSize</span><span>
</span><a name="line-993"></a><span>   </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084414"><span class="hs-identifier hs-var">len_pool</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679084424"><span class="hs-identifier hs-var">maxPoolSize</span></a><span class="hs-special">)</span><span>
</span><a name="line-994"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.TCP.html#close"><span class="hs-identifier hs-var">close</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621679084413"><span class="hs-identifier hs-var">pool</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-995"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084425"><a href="#local-6989586621679084425"><span class="hs-identifier">pool'</span></a></a><span> </span><span>
</span><a name="line-996"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621679084414"><span class="hs-identifier hs-var">len_pool</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679084424"><span class="hs-identifier hs-var">maxPoolSize</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621679084413"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-997"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084413"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-998"></a><span>   </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084424"><span class="hs-identifier hs-var">maxPoolSize</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084426"><a href="#local-6989586621679084426"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084426"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span class="hs-glyph">=</span><a href="#local-6989586621679084412"><span class="hs-identifier hs-var">c</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679084425"><span class="hs-identifier hs-var">pool'</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-999"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>                             </span><span>
</span><a name="line-1001"></a><span class="hs-comment">-- | Default maximum number of open connections we are willing to have active.</span><span>
</span><a name="line-1002"></a><span class="hs-identifier">defaultMaxPoolSize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1003"></a><a name="defaultMaxPoolSize"><a href="Network.Browser.html#defaultMaxPoolSize"><span class="hs-identifier">defaultMaxPoolSize</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">5</span><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span class="hs-identifier">cleanConnectionPool</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.TCP.html#HStream"><span class="hs-identifier hs-type">HStream</span></a><span> </span><a href="#local-6989586621679084138"><span class="hs-identifier hs-type">hTy</span></a><span>
</span><a name="line-1006"></a><span>                    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">URIAuth</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084138"><span class="hs-identifier hs-type">hTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1007"></a><a name="cleanConnectionPool"><a href="Network.Browser.html#cleanConnectionPool"><span class="hs-identifier">cleanConnectionPool</span></a></a><span> </span><a name="local-6989586621679084427"><a href="#local-6989586621679084427"><span class="hs-identifier">uri</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084428"><a href="#local-6989586621679084428"><span class="hs-identifier">ep</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.TCP.html#EndPoint"><span class="hs-identifier hs-var">EndPoint</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">uriRegName</span><span> </span><a href="#local-6989586621679084427"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Base.html#uriAuthPort"><span class="hs-identifier hs-var">uriAuthPort</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621679084427"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><span>  </span><a name="local-6989586621679084429"><a href="#local-6989586621679084429"><span class="hs-identifier">pool</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">gets</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span>
</span><a name="line-1010"></a><span>  </span><a name="local-6989586621679084903"><a href="#local-6989586621679084903"><span class="hs-identifier">bad</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084902"><a href="#local-6989586621679084902"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084902"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-special">`</span><a href="Network.TCP.html#isTCPConnectedTo"><span class="hs-identifier hs-var">isTCPConnectedTo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679084428"><span class="hs-identifier hs-var">ep</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084429"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-1011"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084904"><a href="#local-6989586621679084904"><span class="hs-identifier">tmp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679084903"><span class="hs-identifier hs-var">bad</span></a><span> </span><a href="#local-6989586621679084429"><span class="hs-identifier hs-var">pool</span></a><span>
</span><a name="line-1012"></a><span>      </span><a name="local-6989586621679084905"><a href="#local-6989586621679084905"><span class="hs-identifier">newpool</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084904"><span class="hs-identifier hs-var">tmp</span></a><span>
</span><a name="line-1013"></a><span>      </span><a name="local-6989586621679084906"><a href="#local-6989586621679084906"><span class="hs-identifier">toclose</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621679084904"><span class="hs-identifier hs-var">tmp</span></a><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">forM_</span><span> </span><a href="#local-6989586621679084906"><span class="hs-identifier hs-var">toclose</span></a><span> </span><a href="Network.TCP.html#close"><span class="hs-identifier hs-var">close</span></a><span>
</span><a name="line-1015"></a><span>  </span><span class="hs-identifier hs-var">modify</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084907"><a href="#local-6989586621679084907"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084907"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">bsConnectionPool</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084905"><span class="hs-identifier hs-var">newpool</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span class="hs-identifier">handleCookies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084137"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><a name="handleCookies"><a href="Network.Browser.html#handleCookies"><span class="hs-identifier">handleCookies</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-identifier">_</span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- cut short the silliness.</span><span>
</span><a name="line-1019"></a><span class="hs-identifier">handleCookies</span><span> </span><a name="local-6989586621679084908"><a href="#local-6989586621679084908"><span class="hs-identifier">uri</span></a></a><span> </span><a name="local-6989586621679084909"><a href="#local-6989586621679084909"><span class="hs-identifier">dom</span></a></a><span> </span><a name="local-6989586621679084910"><a href="#local-6989586621679084910"><span class="hs-identifier">cookieHeaders</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1020"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084911"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1021"></a><span>       </span><span class="hs-special">(</span><a href="Network.Browser.html#err"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">unlines</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Errors parsing these cookie values: &quot;</span><span class="hs-glyph">:</span><a href="#local-6989586621679084911"><span class="hs-identifier hs-var">errs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1022"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084912"><span class="hs-identifier hs-var">newCookies</span></a><span class="hs-special">)</span><span>
</span><a name="line-1023"></a><span>       </span><span class="hs-special">(</span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679084913"><a href="#local-6989586621679084913"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679084914"><a href="#local-6989586621679084914"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679084913"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;\n  &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084914"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><span class="hs-string">&quot;Cookies received:&quot;</span><span> </span><a href="#local-6989586621679084912"><span class="hs-identifier hs-var">newCookies</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>  </span><a name="local-6989586621679084915"><a href="#local-6989586621679084915"><span class="hs-identifier">filterfn</span></a></a><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getCookieFilter"><span class="hs-identifier hs-var">getCookieFilter</span></a><span>
</span><a name="line-1025"></a><span>  </span><a name="local-6989586621679084916"><a href="#local-6989586621679084916"><span class="hs-identifier">newCookies'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084915"><span class="hs-identifier hs-var">filterfn</span></a><span> </span><a href="#local-6989586621679084908"><span class="hs-identifier hs-var">uri</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679084912"><span class="hs-identifier hs-var">newCookies</span></a><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679084916"><span class="hs-identifier hs-var">newCookies'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>       </span><span class="hs-special">(</span><a href="Network.Browser.html#out"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;Accepting cookies with names: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unwords</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">ckName</span><span> </span><a href="#local-6989586621679084916"><span class="hs-identifier hs-var">newCookies'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1028"></a><span>  </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="Network.Browser.html#addCookie"><span class="hs-identifier hs-var">addCookie</span></a><span> </span><a href="#local-6989586621679084916"><span class="hs-identifier hs-var">newCookies'</span></a><span>
</span><a name="line-1029"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1030"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679084911"><a href="#local-6989586621679084911"><span class="hs-identifier">errs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679084912"><a href="#local-6989586621679084912"><span class="hs-identifier">newCookies</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Cookie.html#processCookieHeaders"><span class="hs-identifier hs-var">processCookieHeaders</span></a><span> </span><a href="#local-6989586621679084909"><span class="hs-identifier hs-var">dom</span></a><span> </span><a href="#local-6989586621679084910"><span class="hs-identifier hs-var">cookieHeaders</span></a><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span class="hs-identifier">handleConnectionClose</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.TCP.html#HStream"><span class="hs-identifier hs-type">HStream</span></a><span> </span><a href="#local-6989586621679084136"><span class="hs-identifier hs-type">hTy</span></a><span>
</span><a name="line-1033"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">URIAuth</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-type">Header</span></a><span class="hs-special">]</span><span>
</span><a name="line-1034"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><span class="hs-special">(</span><a href="Network.TCP.html#HandleStream"><span class="hs-identifier hs-type">HandleStream</span></a><span> </span><a href="#local-6989586621679084136"><span class="hs-identifier hs-type">hTy</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1035"></a><a name="handleConnectionClose"><a href="Network.Browser.html#handleConnectionClose"><span class="hs-identifier">handleConnectionClose</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1036"></a><span class="hs-identifier">handleConnectionClose</span><span> </span><a name="local-6989586621679084917"><a href="#local-6989586621679084917"><span class="hs-identifier">uri</span></a></a><span> </span><a name="local-6989586621679084918"><a href="#local-6989586621679084918"><span class="hs-identifier">headers</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1037"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084921"><a href="#local-6989586621679084921"><span class="hs-identifier">doClose</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;close&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679084919"><span class="hs-identifier hs-var">headerToConnType</span></a><span> </span><a href="#local-6989586621679084918"><span class="hs-identifier hs-var">headers</span></a><span>
</span><a name="line-1038"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><a href="#local-6989586621679084921"><span class="hs-identifier hs-var">doClose</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Network.Browser.html#cleanConnectionPool"><span class="hs-identifier hs-var">cleanConnectionPool</span></a><span> </span><a href="#local-6989586621679084917"><span class="hs-identifier hs-var">uri</span></a><span>
</span><a name="line-1039"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679084919"><a href="#local-6989586621679084919"><span class="hs-identifier">headerToConnType</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679084920"><a href="#local-6989586621679084920"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toLower</span><span> </span><a href="#local-6989586621679084920"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1040"></a><span>
</span><a name="line-1041"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1042"></a><span class="hs-comment">----------------------- Miscellaneous ----------------------------</span><span>
</span><a name="line-1043"></a><span class="hs-comment">------------------------------------------------------------------</span><span>
</span><a name="line-1044"></a><span>
</span><a name="line-1045"></a><span class="hs-identifier">allowRedirect</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#RequestState"><span class="hs-identifier hs-type">RequestState</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.Browser.html#BrowserAction"><span class="hs-identifier hs-type">BrowserAction</span></a><span> </span><a href="#local-6989586621679084135"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1046"></a><a name="allowRedirect"><a href="Network.Browser.html#allowRedirect"><span class="hs-identifier">allowRedirect</span></a></a><span> </span><a name="local-6989586621679084922"><a href="#local-6989586621679084922"><span class="hs-identifier">rqState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1047"></a><span>  </span><a name="local-6989586621679084923"><a href="#local-6989586621679084923"><span class="hs-identifier">rd</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getAllowRedirects"><span class="hs-identifier hs-var">getAllowRedirects</span></a><span>
</span><a name="line-1048"></a><span>  </span><a name="local-6989586621679084924"><a href="#local-6989586621679084924"><span class="hs-identifier">mbMxRetries</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Network.Browser.html#getMaxRedirects"><span class="hs-identifier hs-var">getMaxRedirects</span></a><span>
</span><a name="line-1049"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679084923"><span class="hs-identifier hs-var">rd</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">reqRedirects</span><span> </span><a href="#local-6989586621679084922"><span class="hs-identifier hs-var">rqState</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="Network.Browser.html#defaultMaxRetries"><span class="hs-identifier hs-var">defaultMaxRetries</span></a><span> </span><a href="#local-6989586621679084924"><span class="hs-identifier hs-var">mbMxRetries</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span class="hs-comment">-- | Return @True@ iff the package is able to handle requests and responses</span><span>
</span><a name="line-1052"></a><span class="hs-comment">-- over it.</span><span>
</span><a name="line-1053"></a><span class="hs-identifier">supportedScheme</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1054"></a><a name="supportedScheme"><a href="Network.Browser.html#supportedScheme"><span class="hs-identifier">supportedScheme</span></a></a><span> </span><a name="local-6989586621679084925"><a href="#local-6989586621679084925"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uriScheme</span><span> </span><a href="#local-6989586621679084925"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;http:&quot;</span><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span class="hs-comment">-- | @uriDefaultTo a b@ returns a URI that is consistent with the first</span><span>
</span><a name="line-1057"></a><span class="hs-comment">-- argument URI @a@ when read in the context of the second URI @b@.</span><span>
</span><a name="line-1058"></a><span class="hs-comment">-- If the second argument is not sufficient context for determining</span><span>
</span><a name="line-1059"></a><span class="hs-comment">-- a full URI then anarchy reins.</span><span>
</span><a name="line-1060"></a><span class="hs-identifier">uriDefaultTo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">URI</span><span>
</span><a name="line-1061"></a><span class="hs-cpp">#if MIN_VERSION_network(2,4,0)</span><span>
</span><a name="line-1062"></a><a name="uriDefaultTo"><a href="Network.Browser.html#uriDefaultTo"><span class="hs-identifier">uriDefaultTo</span></a></a><span> </span><a name="local-6989586621679084926"><a href="#local-6989586621679084926"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679084927"><a href="#local-6989586621679084927"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679084926"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">relativeTo</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679084927"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1063"></a><span class="hs-cpp">#else</span><span>
</span><a name="line-1064"></a><span class="hs-identifier">uriDefaultTo</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">maybe</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">relativeTo</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span class="hs-cpp">#endif</span><span>
</span><a name="line-1066"></a><span>
</span><a name="line-1067"></a><span>
</span><a name="line-1068"></a><span class="hs-comment">-- This form junk is completely untested...</span><span>
</span><a name="line-1069"></a><span>
</span><a name="line-1070"></a><span class="hs-keyword">type</span><span> </span><a name="FormVar"><a href="Network.Browser.html#FormVar"><span class="hs-identifier">FormVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-1071"></a><span>
</span><a name="line-1072"></a><span class="hs-keyword">data</span><span> </span><a name="Form"><a href="Network.Browser.html#Form"><span class="hs-identifier">Form</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Form"><a href="Network.Browser.html#Form"><span class="hs-identifier">Form</span></a></a><span> </span><a href="Network.HTTP.Base.html#RequestMethod"><span class="hs-identifier hs-type">RequestMethod</span></a><span> </span><span class="hs-identifier hs-type">URI</span><span> </span><span class="hs-special">[</span><a href="Network.Browser.html#FormVar"><span class="hs-identifier hs-type">FormVar</span></a><span class="hs-special">]</span><span>
</span><a name="line-1073"></a><span>
</span><a name="line-1074"></a><span class="hs-identifier">formToRequest</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Network.Browser.html#Form"><span class="hs-identifier hs-type">Form</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Base.html#Request_String"><span class="hs-identifier hs-type">Request_String</span></a><span>
</span><a name="line-1075"></a><a name="formToRequest"><a href="Network.Browser.html#formToRequest"><span class="hs-identifier">formToRequest</span></a></a><span> </span><span class="hs-special">(</span><a href="Network.Browser.html#Form"><span class="hs-identifier hs-var">Form</span></a><span> </span><a name="local-6989586621679084928"><a href="#local-6989586621679084928"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679084929"><a href="#local-6989586621679084929"><span class="hs-identifier">u</span></a></a><span> </span><a name="local-6989586621679084930"><a href="#local-6989586621679084930"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679084931"><a href="#local-6989586621679084931"><span class="hs-identifier">enc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Network.HTTP.Base.html#urlEncodeVars"><span class="hs-identifier hs-var">urlEncodeVars</span></a><span> </span><a href="#local-6989586621679084930"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-1077"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679084928"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1078"></a><span>        </span><a href="Network.HTTP.Base.html#GET"><span class="hs-identifier hs-var">GET</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Base.html#Request"><span class="hs-identifier hs-var">Request</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rqMethod</span><span class="hs-glyph">=</span><a href="Network.HTTP.Base.html#GET"><span class="hs-identifier hs-var">GET</span></a><span>
</span><a name="line-1079"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqHeaders</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span> </span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrContentLength"><span class="hs-identifier hs-var">HdrContentLength</span></a><span> </span><span class="hs-string">&quot;0&quot;</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1080"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqBody</span><span class="hs-glyph">=</span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1081"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqURI</span><span class="hs-glyph">=</span><a href="#local-6989586621679084929"><span class="hs-identifier hs-var">u</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uriQuery</span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'?'</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679084931"><span class="hs-identifier hs-var">enc</span></a><span> </span><span class="hs-special">}</span><span>  </span><span class="hs-comment">-- What about old query?</span><span>
</span><a name="line-1082"></a><span>                       </span><span class="hs-special">}</span><span>
</span><a name="line-1083"></a><span>        </span><a href="Network.HTTP.Base.html#POST"><span class="hs-identifier hs-var">POST</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Network.HTTP.Base.html#Request"><span class="hs-identifier hs-var">Request</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rqMethod</span><span class="hs-glyph">=</span><a href="Network.HTTP.Base.html#POST"><span class="hs-identifier hs-var">POST</span></a><span>
</span><a name="line-1084"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqHeaders</span><span class="hs-glyph">=</span><span class="hs-special">[</span><span> </span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrContentType"><span class="hs-identifier hs-var">HdrContentType</span></a><span> </span><span class="hs-string">&quot;application/x-www-form-urlencoded&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-1085"></a><span>                                      </span><a href="Network.HTTP.Headers.html#Header"><span class="hs-identifier hs-var">Header</span></a><span> </span><a href="Network.HTTP.Headers.html#HdrContentLength"><span class="hs-identifier hs-var">HdrContentLength</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679084931"><span class="hs-identifier hs-var">enc</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1086"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqBody</span><span class="hs-glyph">=</span><a href="#local-6989586621679084931"><span class="hs-identifier hs-var">enc</span></a><span>
</span><a name="line-1087"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rqURI</span><span class="hs-glyph">=</span><a href="#local-6989586621679084929"><span class="hs-identifier hs-var">u</span></a><span>
</span><a name="line-1088"></a><span>                        </span><span class="hs-special">}</span><span>
</span><a name="line-1089"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;unexpected request: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679084928"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1090"></a><span>
</span><a name="line-1091"></a><span>
</span><a name="line-1092"></a></pre></body></html>